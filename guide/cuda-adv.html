<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>ç¬¬ 6 ç«  CUDAé«˜çº§ä¼˜åŒ–æŠ€å·§ | x40å¹¶è¡Œç¼–ç¨‹æŒ‡å—</title>
  <meta name="description" content="åœ¨x40æœåŠ¡å™¨ä¸Šå¹¶è¡Œè¿ç®—" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="ç¬¬ 6 ç«  CUDAé«˜çº§ä¼˜åŒ–æŠ€å·§ | x40å¹¶è¡Œç¼–ç¨‹æŒ‡å—" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="åœ¨x40æœåŠ¡å™¨ä¸Šå¹¶è¡Œè¿ç®—" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="ç¬¬ 6 ç«  CUDAé«˜çº§ä¼˜åŒ–æŠ€å·§ | x40å¹¶è¡Œç¼–ç¨‹æŒ‡å—" />
  
  <meta name="twitter:description" content="åœ¨x40æœåŠ¡å™¨ä¸Šå¹¶è¡Œè¿ç®—" />
  

<meta name="author" content="cucumber" />


<meta name="date" content="2020-09-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="cuda.html"/>
<link rel="next" href="nsight.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css\style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">x40å¹¶è¡Œç¼–ç¨‹æŒ‡å—</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>å‰è¨€</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#è‡´è°¢"><i class="fa fa-check"></i>è‡´è°¢</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="author.html"><a href="author.html"><i class="fa fa-check"></i>ä½œè€…ç®€ä»‹</a></li>
<li class="chapter" data-level="" data-path="x40.html"><a href="x40.html"><i class="fa fa-check"></i>x40æœåŠ¡å™¨</a><ul>
<li class="chapter" data-level="0.1" data-path="x40.html"><a href="x40.html#åŸºæœ¬ç¡¬ä»¶ä¿¡æ¯"><i class="fa fa-check"></i><b>0.1</b> åŸºæœ¬ç¡¬ä»¶ä¿¡æ¯</a></li>
</ul></li>
<li class="part"><span><b>I cè¯­è¨€å¹¶è¡Œç¼–ç¨‹</b></span></li>
<li class="chapter" data-level="1" data-path="csimd.html"><a href="csimd.html"><i class="fa fa-check"></i><b>1</b> SIMD å’Œ SSE/AVX</a><ul>
<li class="chapter" data-level="1.1" data-path="csimd.html"><a href="csimd.html#muladd_base"><i class="fa fa-check"></i><b>1.1</b> ä¸€ä¸ªç®€å•çš„ç¨‹åº</a></li>
<li class="chapter" data-level="1.2" data-path="csimd.html"><a href="csimd.html#csimd_first"><i class="fa fa-check"></i><b>1.2</b> æˆ‘çš„ç¬¬ä¸€ä¸ªSIMDç¨‹åºï¼</a></li>
<li class="chapter" data-level="1.3" data-path="csimd.html"><a href="csimd.html#csimd_reg"><i class="fa fa-check"></i><b>1.3</b> æä¸ªå¯„å­˜å™¨å˜é‡</a></li>
<li class="chapter" data-level="1.4" data-path="csimd.html"><a href="csimd.html#csimd_asm"><i class="fa fa-check"></i><b>1.4</b> æˆ‘æ¯”ç¼–è¯‘å™¨èªæ˜ç³»åˆ—</a></li>
<li class="chapter" data-level="1.5" data-path="csimd.html"><a href="csimd.html#csimd_gccO3"><i class="fa fa-check"></i><b>1.5</b> ç¼–è¯‘å™¨æ¯”æˆ‘èªæ˜ç³»åˆ—</a></li>
<li class="chapter" data-level="1.6" data-path="csimd.html"><a href="csimd.html#csimd_sum"><i class="fa fa-check"></i><b>1.6</b> æœ¬ç« å°ç»“</a></li>
<li class="chapter" data-level="1.7" data-path="csimd.html"><a href="csimd.html#csimd_add"><i class="fa fa-check"></i><b>1.7</b> è¡¥å……å†…å®¹</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cmt.html"><a href="cmt.html"><i class="fa fa-check"></i><b>2</b> cè¯­è¨€å¤šçº¿ç¨‹ç¼–ç¨‹</a><ul>
<li class="chapter" data-level="2.1" data-path="cmt.html"><a href="cmt.html#cmt_muladd"><i class="fa fa-check"></i><b>2.1</b> è¿˜æ˜¯ä¹˜åŠ è¿ç®—</a></li>
<li class="chapter" data-level="2.2" data-path="cmt.html"><a href="cmt.html#cmt_sum"><i class="fa fa-check"></i><b>2.2</b> æœ¬ç« å°ç»“</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="fma.html"><a href="fma.html"><i class="fa fa-check"></i><b>3</b> ç¬¬ä¸€éƒ¨åˆ†ç»“æŸè¯­</a></li>
<li class="part"><span><b>II GPGPU</b></span></li>
<li class="chapter" data-level="4" data-path="gpuintro.html"><a href="gpuintro.html"><i class="fa fa-check"></i><b>4</b> GPUç®€ä»‹</a><ul>
<li class="chapter" data-level="4.1" data-path="gpuintro.html"><a href="gpuintro.html#gpu_about"><i class="fa fa-check"></i><b>4.1</b> å›¾å½¢å¤„ç†æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</a></li>
<li class="chapter" data-level="4.2" data-path="gpuintro.html"><a href="gpuintro.html#gpu_gpgpu"><i class="fa fa-check"></i><b>4.2</b> é‚£GPGPUæ˜¯å•¥ï¼Ÿ</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="cuda.html"><a href="cuda.html"><i class="fa fa-check"></i><b>5</b> CUDA</a><ul>
<li class="chapter" data-level="5.1" data-path="cuda.html"><a href="cuda.html#before_start"><i class="fa fa-check"></i><b>5.1</b> å¼€å§‹ä¹‹å‰</a></li>
<li class="chapter" data-level="5.2" data-path="cuda.html"><a href="cuda.html#cuda_first"><i class="fa fa-check"></i><b>5.2</b> æˆ‘çš„ç¬¬ä¸€ä¸ªcudaç¨‹åº</a><ul>
<li class="chapter" data-level="5.2.1" data-path="cuda.html"><a href="cuda.html#include-cuda_runtime.h"><i class="fa fa-check"></i><b>5.2.1</b> #include &lt;cuda_runtime.h&gt;</a></li>
<li class="chapter" data-level="5.2.2" data-path="cuda.html"><a href="cuda.html#global__-void-muladd"><i class="fa fa-check"></i><b>5.2.2</b> <code>__global__ void muladd</code></a></li>
<li class="chapter" data-level="5.2.3" data-path="cuda.html"><a href="cuda.html#blockidxblockdimå’Œthreadidx"><i class="fa fa-check"></i><b>5.2.3</b> <code>blockIdx</code>,<code>blockDim</code>å’Œ<code>threadIdx</code></a></li>
<li class="chapter" data-level="5.2.4" data-path="cuda.html"><a href="cuda.html#cudamalloc"><i class="fa fa-check"></i><b>5.2.4</b> <code>cudaMalloc</code></a></li>
<li class="chapter" data-level="5.2.5" data-path="cuda.html"><a href="cuda.html#cudamemcpy"><i class="fa fa-check"></i><b>5.2.5</b> <code>cudaMemcpy</code></a></li>
<li class="chapter" data-level="5.2.6" data-path="cuda.html"><a href="cuda.html#section"><i class="fa fa-check"></i><b>5.2.6</b> <code>&lt;&lt;&lt;32, 256&gt;&gt;&gt;</code></a></li>
<li class="chapter" data-level="5.2.7" data-path="cuda.html"><a href="cuda.html#cudafree"><i class="fa fa-check"></i><b>5.2.7</b> <code>cudaFree</code></a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="cuda.html"><a href="cuda.html#cudaæ–°å¢ç±»å‹"><i class="fa fa-check"></i><b>5.3</b> CUDAæ–°å¢ç±»å‹</a></li>
<li class="chapter" data-level="5.4" data-path="cuda.html"><a href="cuda.html#cuda_device"><i class="fa fa-check"></i><b>5.4</b> ä½¿ç”¨<code>__device__</code>å‡½æ•°</a></li>
<li class="chapter" data-level="5.5" data-path="cuda.html"><a href="cuda.html#cuda_shared"><i class="fa fa-check"></i><b>5.5</b> ç”ŸæˆåŠ¨æ€é“¾æ¥åº“</a><ul>
<li class="chapter" data-level="5.5.1" data-path="cuda.html"><a href="cuda.html#ç”¨cåšä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“"><i class="fa fa-check"></i><b>5.5.1</b> ç”¨c++åšä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“</a></li>
<li class="chapter" data-level="5.5.2" data-path="cuda.html"><a href="cuda.html#ç”Ÿæˆcudaçš„åŠ¨æ€é“¾æ¥åº“"><i class="fa fa-check"></i><b>5.5.2</b> ç”Ÿæˆcudaçš„åŠ¨æ€é“¾æ¥åº“</a></li>
<li class="chapter" data-level="5.5.3" data-path="cuda.html"><a href="cuda.html#ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“"><i class="fa fa-check"></i><b>5.5.3</b> ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“</a></li>
<li class="chapter" data-level="5.5.4" data-path="cuda.html"><a href="cuda.html#åœ¨rootä¸­äº¤äº’åœ°ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“"><i class="fa fa-check"></i><b>5.5.4</b> åœ¨rootä¸­äº¤äº’åœ°ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“</a></li>
<li class="chapter" data-level="5.5.5" data-path="cuda.html"><a href="cuda.html#åœ¨rootä¸­äº¤äº’åœ°ä½¿ç”¨cudaçš„å®Œæ•´ä¾‹å­"><i class="fa fa-check"></i><b>5.5.5</b> åœ¨rootä¸­äº¤äº’åœ°ä½¿ç”¨cudaçš„å®Œæ•´ä¾‹å­</a></li>
<li class="chapter" data-level="5.5.6" data-path="cuda.html"><a href="cuda.html#ä¸æ”¯æŒcçš„æƒ…å†µ"><i class="fa fa-check"></i><b>5.5.6</b> ä¸æ”¯æŒc++çš„æƒ…å†µ</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="cuda.html"><a href="cuda.html#cudabase_sum"><i class="fa fa-check"></i><b>5.6</b> æœ¬ç« å°ç»“</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="cuda-adv.html"><a href="cuda-adv.html"><i class="fa fa-check"></i><b>6</b> CUDAé«˜çº§ä¼˜åŒ–æŠ€å·§</a><ul>
<li class="chapter" data-level="6.1" data-path="cuda-adv.html"><a href="cuda-adv.html#çº¹ç†å’Œçº¹ç†å†…å­˜"><i class="fa fa-check"></i><b>6.1</b> çº¹ç†å’Œçº¹ç†å†…å­˜</a><ul>
<li class="chapter" data-level="6.1.1" data-path="cuda-adv.html"><a href="cuda-adv.html#ä»€ä¹ˆæ˜¯çº¹ç†"><i class="fa fa-check"></i><b>6.1.1</b> ä»€ä¹ˆæ˜¯çº¹ç†ï¼Ÿ</a></li>
<li class="chapter" data-level="6.1.2" data-path="cuda-adv.html"><a href="cuda-adv.html#cudaçº¹ç†çš„å¯»å€æ¨¡å¼å’Œçº¿æ€§æ’å€¼"><i class="fa fa-check"></i><b>6.1.2</b> CUDAçº¹ç†çš„å¯»å€æ¨¡å¼å’Œçº¿æ€§æ’å€¼</a></li>
<li class="chapter" data-level="6.1.3" data-path="cuda-adv.html"><a href="cuda-adv.html#ä¸¾ä¸€ä¸ªä¾‹å­"><i class="fa fa-check"></i><b>6.1.3</b> ä¸¾ä¸€ä¸ªä¾‹å­</a></li>
<li class="chapter" data-level="6.1.4" data-path="cuda-adv.html"><a href="cuda-adv.html#å¦‚ä½•å®ç°åŒç²¾åº¦çº¹ç†"><i class="fa fa-check"></i><b>6.1.4</b> å¦‚ä½•å®ç°åŒç²¾åº¦çº¹ç†</a></li>
<li class="chapter" data-level="6.1.5" data-path="cuda-adv.html"><a href="cuda-adv.html#æ‰€ä»¥ä¸ºä»€ä¹ˆè¦ç”¨çº¹ç†"><i class="fa fa-check"></i><b>6.1.5</b> æ‰€ä»¥ä¸ºä»€ä¹ˆè¦ç”¨çº¹ç†ï¼Ÿ</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="cuda-adv.html"><a href="cuda-adv.html#æµ"><i class="fa fa-check"></i><b>6.2</b> æµ</a><ul>
<li class="chapter" data-level="6.2.1" data-path="cuda-adv.html"><a href="cuda-adv.html#ä¸¾ä¸ªä¾‹å­"><i class="fa fa-check"></i><b>6.2.1</b> ä¸¾ä¸ªä¾‹å­</a></li>
<li class="chapter" data-level="6.2.2" data-path="cuda-adv.html"><a href="cuda-adv.html#å›è°ƒ"><i class="fa fa-check"></i><b>6.2.2</b> å›è°ƒ</a></li>
<li class="chapter" data-level="6.2.3" data-path="cuda-adv.html"><a href="cuda-adv.html#ä»€ä¹ˆæ—¶å€™è¦ä½¿ç”¨æµ"><i class="fa fa-check"></i><b>6.2.3</b> ä»€ä¹ˆæ—¶å€™è¦ä½¿ç”¨æµ</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="cuda-adv.html"><a href="cuda-adv.html#ç¼“å­˜å’Œå…±äº«å†…å­˜çš„åˆ†é…"><i class="fa fa-check"></i><b>6.3</b> ç¼“å­˜å’Œå…±äº«å†…å­˜çš„åˆ†é…</a></li>
<li class="chapter" data-level="6.4" data-path="cuda-adv.html"><a href="cuda-adv.html#cuadv_sum"><i class="fa fa-check"></i><b>6.4</b> æœ¬ç« å°ç»“</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="nsight.html"><a href="nsight.html"><i class="fa fa-check"></i><b>7</b> ä½¿ç”¨Nsightä¼˜åŒ–ç¨‹åº</a><ul>
<li class="chapter" data-level="7.1" data-path="nsight.html"><a href="nsight.html#ä¸‹è½½å’Œå®‰è£…"><i class="fa fa-check"></i><b>7.1</b> ä¸‹è½½å’Œå®‰è£…</a></li>
<li class="chapter" data-level="7.2" data-path="nsight.html"><a href="nsight.html#è¿æ¥åˆ°æœåŠ¡å™¨"><i class="fa fa-check"></i><b>7.2</b> è¿æ¥åˆ°æœåŠ¡å™¨</a></li>
<li class="chapter" data-level="7.3" data-path="nsight.html"><a href="nsight.html#åˆ†æç¨‹åº"><i class="fa fa-check"></i><b>7.3</b> åˆ†æç¨‹åº</a></li>
<li class="chapter" data-level="7.4" data-path="nsight.html"><a href="nsight.html#æŸ¥çœ‹æŠ¥å‘Š"><i class="fa fa-check"></i><b>7.4</b> æŸ¥çœ‹æŠ¥å‘Š</a></li>
</ul></li>
<li class="appendix"><span><b>é™„å½•</b></span></li>
<li class="chapter" data-level="A" data-path="assemble.html"><a href="assemble.html"><i class="fa fa-check"></i><b>A</b> æ±‡ç¼–è¯­è¨€ç®€ä»‹</a><ul>
<li class="chapter" data-level="A.1" data-path="assemble.html"><a href="assemble.html#åŸºæœ¬æ“ä½œ"><i class="fa fa-check"></i><b>A.1</b> åŸºæœ¬æ“ä½œ</a></li>
<li class="chapter" data-level="A.2" data-path="assemble.html"><a href="assemble.html#ç¥å¥‡çš„è£…è½½æœ‰æ•ˆåœ°å€"><i class="fa fa-check"></i><b>A.2</b> ç¥å¥‡çš„â€œè£…è½½æœ‰æ•ˆåœ°å€â€</a></li>
<li class="chapter" data-level="A.3" data-path="assemble.html"><a href="assemble.html#cè¯­è¨€ä¸­çš„å†…è”æ±‡ç¼–"><i class="fa fa-check"></i><b>A.3</b> cè¯­è¨€ä¸­çš„å†…è”æ±‡ç¼–</a></li>
</ul></li>
<li class="chapter" data-level="B" data-path="float.html"><a href="float.html"><i class="fa fa-check"></i><b>B</b> æµ®ç‚¹æ•°çš„è®¡ç®—æœºè¡¨ç¤º</a><ul>
<li class="chapter" data-level="B.1" data-path="float.html"><a href="float.html#å•ç²¾åº¦æµ®ç‚¹æ•°"><i class="fa fa-check"></i><b>B.1</b> å•ç²¾åº¦æµ®ç‚¹æ•°</a><ul>
<li class="chapter" data-level="B.1.1" data-path="float.html"><a href="float.html#è§„æ ¼åŒ–çš„å•ç²¾åº¦æµ®ç‚¹æ•°"><i class="fa fa-check"></i><b>B.1.1</b> è§„æ ¼åŒ–çš„å•ç²¾åº¦æµ®ç‚¹æ•°</a></li>
<li class="chapter" data-level="B.1.2" data-path="float.html"><a href="float.html#éè§„æ ¼åŒ–çš„å•ç²¾åº¦æµ®ç‚¹æ•°"><i class="fa fa-check"></i><b>B.1.2</b> éè§„æ ¼åŒ–çš„å•ç²¾åº¦æµ®ç‚¹æ•°</a></li>
<li class="chapter" data-level="B.1.3" data-path="float.html"><a href="float.html#ç‰¹æ®Šå€¼"><i class="fa fa-check"></i><b>B.1.3</b> ç‰¹æ®Šå€¼</a></li>
</ul></li>
<li class="chapter" data-level="B.2" data-path="float.html"><a href="float.html#åŒç²¾åº¦æµ®ç‚¹æ•°å’ŒåŠç²¾åº¦æµ®ç‚¹æ•°"><i class="fa fa-check"></i><b>B.2</b> åŒç²¾åº¦æµ®ç‚¹æ•°å’ŒåŠç²¾åº¦æµ®ç‚¹æ•°</a></li>
</ul></li>
<li class="chapter" data-level="C" data-path="cache.html"><a href="cache.html"><i class="fa fa-check"></i><b>C</b> é«˜é€Ÿç¼“å­˜</a><ul>
<li class="chapter" data-level="C.1" data-path="cache.html"><a href="cache.html#å±€éƒ¨æ€§åŸç†"><i class="fa fa-check"></i><b>C.1</b> å±€éƒ¨æ€§åŸç†</a></li>
<li class="chapter" data-level="C.2" data-path="cache.html"><a href="cache.html#ç¼“å­˜çš„ç»„æ€"><i class="fa fa-check"></i><b>C.2</b> ç¼“å­˜çš„ç»„æ€</a></li>
<li class="chapter" data-level="C.3" data-path="cache.html"><a href="cache.html#ç¼“å­˜ä¼˜åŒ–"><i class="fa fa-check"></i><b>C.3</b> ç¼“å­˜ä¼˜åŒ–</a></li>
<li class="chapter" data-level="C.4" data-path="cache.html"><a href="cache.html#å¦‚ä½•æŸ¥çœ‹cpuçš„ç¼“å­˜ç»„æ€"><i class="fa fa-check"></i><b>C.4</b> å¦‚ä½•æŸ¥çœ‹cpuçš„ç¼“å­˜ç»„æ€</a></li>
<li class="chapter" data-level="C.5" data-path="cache.html"><a href="cache.html#æ„Ÿå—ä¸€ä¸‹ç¼“å­˜ä¸å‘½ä¸­"><i class="fa fa-check"></i><b>C.5</b> æ„Ÿå—ä¸€ä¸‹ç¼“å­˜ä¸å‘½ä¸­</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>å‚è€ƒæ–‡çŒ®</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">æœ¬ä¹¦ç”± bookdown å¼ºåŠ›é©±åŠ¨</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">x40å¹¶è¡Œç¼–ç¨‹æŒ‡å—</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="cuda_adv" class="section level1">
<h1><span class="header-section-number">ç¬¬ 6 ç« </span> CUDAé«˜çº§ä¼˜åŒ–æŠ€å·§</h1>
<p>è¿™ä¸€ç« è™½ç„¶ç§°ä¸ºé«˜çº§ä¼˜åŒ–æŠ€å·§ï¼Œå…¶å®ä¸ç®—ä»€ä¹ˆé«˜çº§å†…å®¹ï¼Œåªæ˜¯ä»‹ç»ä¸€äº›æœ‰ç”¨çš„ç‰¹æ€§ã€‚</p>
<div id="çº¹ç†å’Œçº¹ç†å†…å­˜" class="section level2">
<h2><span class="header-section-number">6.1</span> çº¹ç†å’Œçº¹ç†å†…å­˜</h2>
<blockquote>
<p><em>ä½™å¿†ç«¥ç¨šæ—¶ï¼Œèƒ½å¼ ç›®å¯¹æ—¥ï¼Œæ˜å¯Ÿç§‹æ¯«ã€‚è§è—å°å¾®ç‰©ï¼Œå¿…ç»†å¯Ÿå…¶çº¹ç†ï¼Œæ•…æ—¶æœ‰ç‰©å¤–ä¹‹è¶£ã€‚â€”â€”ã€Šæµ®ç”Ÿå…­è®°ã€‹</em></p>
</blockquote>
<div id="ä»€ä¹ˆæ˜¯çº¹ç†" class="section level3">
<h3><span class="header-section-number">6.1.1</span> ä»€ä¹ˆæ˜¯çº¹ç†ï¼Ÿ</h3>
<p>åœ¨å›¾å½¢å­¦ä¸­ï¼Œçº¹ç†æœ¬æ¥æ˜¯ä¸€å¹…å›¾åƒï¼Œç”¨æ¥è¢«â€œè´´â€åœ¨è¦æ˜¾ç¤ºçš„ä½ç½®ã€‚ç”±äºè§‚å¯Ÿè§’åº¦ä¸åŒï¼Œæ˜¾ç¤ºçš„ç‚¹åˆ°çº¹ç†ä¸Šçš„ç‚¹ä¼šæœ‰ä¸åŒçš„æ˜ å°„å…³ç³»ã€‚</p>
<p>ä»çº¹ç†ä¸­å–å¾—ä¿¡æ¯å’Œä»æ•°ç»„ä¸­å–å¾—å€¼æ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯ä»çº¹ç†ä¸­å–å€¼è¢«ç§°ä½œâ€œæ‹¾å–â€(fetch)ï¼Œå–åˆ°çš„å†…å®¹ç§°ä½œâ€œtexelâ€ã€‚</p>
<p>ä½†æ˜¯å’Œä»æ•°ç»„ä¸­å–å€¼ä¸åŒï¼Œæ‹¾å–çº¹ç†å¯ä»¥ä½¿ç”¨éæ•´æ•°çš„ä¸‹æ ‡ï¼Œç”šè‡³å¯ä»¥è‡ªåŠ¨è¿›è¡Œæ’å€¼ã€‚</p>
<p>CUDAæ”¯æŒæ•´æ•°çº¹ç†å’Œå•ç²¾åº¦æµ®ç‚¹æ•°çº¹ç†ä»¥åŠç›¸åº”çš„2ç»´æˆ–4ç»´çŸ¢é‡çº¹ç†ã€‚ï¼ˆè¿™é‡Œè¯´çš„æ˜¯çº¹ç†é‡Œé¢çš„å€¼ï¼Œç›¸å½“äºæ•°ç»„çš„ç±»å‹æ˜¯æ•´æ•°/å•ç²¾åº¦æµ®ç‚¹æ•°æˆ–è€…å®ƒä»¬å¯¹åº”çš„çŸ¢é‡ç±»å‹ï¼‰ã€‚</p>
</div>
<div id="cudaçº¹ç†çš„å¯»å€æ¨¡å¼å’Œçº¿æ€§æ’å€¼" class="section level3">
<h3><span class="header-section-number">6.1.2</span> CUDAçº¹ç†çš„å¯»å€æ¨¡å¼å’Œçº¿æ€§æ’å€¼</h3>
<p>CUDAçš„çº¹ç†æ”¯æŒâ€œå½’ä¸€åŒ–â€ï¼Œå³å°†åæ ‡å’Œ/æˆ–å€¼çº¿æ€§æ˜ å°„åˆ°é›¶åˆ°ä¸€çš„åŒºé—´é‡Œã€‚</p>
<p>CUDAçº¹ç†æ”¯æŒæ•´æ•°æ‹¾å–å’Œæµ®ç‚¹æ•°æ‹¾å–ã€‚åŒæ—¶å¯¹è¶…è¿‡è¾¹ç•Œçš„æ‹¾å–å¯è®¾å®šä¸ºâ€œç¯ç»•â€(wrap)ï¼Œâ€œé’³åˆ¶â€(clamp)ï¼Œâ€œé•œåƒâ€ï¼ˆmirrorï¼‰æˆ–è€…â€œè¾¹ç•Œâ€ï¼ˆborderï¼‰ã€‚å‡ ç§è¾¹ç•Œæ¨¡å¼çš„ä¸åŒå¦‚ä¸‹ï¼ˆå‡è®¾æ˜¯1ç»´çš„æƒ…å†µï¼Œçº¹ç†é‡Œçš„å†…å®¹æ˜¯(1, 2, 3, 4)ï¼Œåªåˆ—å‡ºä»-4åˆ°7çš„â€œæ•´æ•°ç‚¹â€çš„å€¼ï¼‰</p>
<ul>
<li>ç¯ç»•ï¼š(1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4)<br />
</li>
<li>é’³åˆ¶ï¼š(1, 1, 1, 1, 1, 2, 3, 4, 4, 4, 4, 4)<br />
</li>
<li>é•œåƒï¼š(4, 3, 2, 1, 1, 2, 3, 4, 4, 3, 2, 1)<br />
</li>
<li>è¾¹ç•Œï¼š(0, 0, 0, 0, 1, 2, 3, 4, 0, 0, 0, 0)</li>
</ul>
<blockquote>
<p>è¿™é‡Œâ€œæ•´æ•°ç‚¹â€åŠ å¼•å·æ˜¯ç”±äºçº¹ç´ çš„åæ ‡å…¶å®æ˜¯æœ‰0.5çš„åç§»çš„ã€‚ç”¨æ•°ç»„æ¥ä¸¾ä¾‹ï¼š<br />
å¦‚æœæœ‰æ•°ç»„aï¼Œa[0]=0, a[1]=1, a[2]=2, a[3]=3<br />
é‚£ä¹ˆï¼ŒåŒæ ·çš„çº¹ç†tï¼Œt[0.5]=0, t[1.5]=1, t[2.5]=2, t[3,5]=3<br />
å¯ä»¥ç†è§£ä¸ºç±»ä¼¼æŠŠä¸€ä¸ªåƒç´ å˜æˆä¸€ä¸ªå•ä½æ­£æ–¹å½¢ï¼Œæ­£æ–¹å½¢çš„ä¸­å¿ƒåæ ‡å’Œç¼–å·æ¯”èµ·æ¥æ˜¯æœ‰0.5çš„åç§»çš„ã€‚</p>
</blockquote>
<p>æ³¨æ„ï¼Œç¯ç»•å’Œé•œåƒæ¨¡å¼åªèƒ½åœ¨åæ ‡â€œå½’ä¸€åŒ–â€çš„çš„çº¹ç†ä¸­ä½¿ç”¨ã€‚</p>
<p>CUDAçº¹ç†æ”¯æŒä¸¤ç§è¿‡æ»¤æ¨¡å¼ï¼Œâ€œæœ€è¿‘ç‚¹â€å’Œâ€œçº¿æ€§æ’å€¼â€ã€‚é¡¾åæ€ä¹‰ï¼Œæœ€è¿‘ç‚¹å–åæ ‡æœ€è¿‘çš„æ ¼ç‚¹çš„å€¼ï¼Œè€Œçº¿æ€§æ’å€¼åˆ™æ˜¯ç”¨ç›¸é‚»çš„æ ¼ç‚¹çš„å€¼è¿›è¡Œçº¿æ€§æ’å€¼æ¥ä½œä¸ºæ‹¾å–åˆ°çš„å€¼ã€‚è¿™é‡Œï¼Œâ€œæœ€è¿‘ç‚¹â€ç”¨çš„æ˜¯å·¦é—­å³å¼€åŒºé—´ï¼Œå³t[0]=t[0.5]=t[0.99],t[1]=t[1.5]ç­‰ç­‰ã€‚</p>
<p><strong>æ³¨æ„ï¼çº¿æ€§æ’å€¼çš„ç²¾åº¦æ˜¯æœ‰é™çš„ã€‚å†…éƒ¨æ˜¯ç”¨ä¸€ä¸ª8bitçš„æ•°åšæ’å€¼(æˆ‘ç†è§£æ˜¯æŠŠä¸€ä¸ªæ ¼å­åˆ†æˆ256ä»½çš„æ„æ€)ã€‚æ‰€ä»¥å¦‚æœå¯¹ç²¾åº¦è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå»ºè®®ç”¨æœ€è¿‘ç‚¹æ¨¡å¼ç„¶åæ‰‹åŠ¨æ’å€¼ã€‚å¦‚æœå¯¹ç²¾åº¦è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜çš„è¯ï¼Œç”¨çº¿æ€§æ’å€¼æ¨¡å¼å¯ä»¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚</strong></p>
<p><strong>æ³¨æ„ï¼çº¹ç†æ‹¾å–å‡½æ•°æ¥å—çš„å‚æ•°æ˜¯å•ç²¾åº¦æµ®ç‚¹æ•°ã€‚å¦‚æœåæ ‡æ˜¯åŒç²¾åº¦æµ®ç‚¹æ•°çš„è¯ä¼šè‡ªåŠ¨è½¬æ¢æˆå•ç²¾åº¦ã€‚ä½†æ˜¯åœ¨æœ€è¿‘ç‚¹æ¨¡å¼ä¸­ï¼ŒåŒç²¾åº¦è½¬å•ç²¾åº¦å¹¶ä¸æ˜¯æˆªæ–­çš„ï¼Œè€Œæ˜¯èˆå…¥åˆ°æœ€è¿‘çš„å•ç²¾åº¦æµ®ç‚¹ï¼Œè¿™æ„å‘³ç€æœ‰å¯èƒ½å› ä¸ºè¿›ä½è€Œå¯¼è‡´æ‹¾å–åˆ°ä¸åŒçš„å€¼ï¼Œè¿™åœ¨æ‰‹åŠ¨æ’å€¼çš„æƒ…å†µä¸‹ä¼šå¼•å‘é—®é¢˜ã€‚å»ºè®®æ‰‹åŠ¨è½¬æ¢è‡³å•ç²¾åº¦æˆ–å‘ä¸‹å–æ•´åä¼ å…¥å‚æ•°ã€‚ï¼ˆå»ºè®®ä½¿ç”¨<code>__double2float_rd(double)</code>æ‰‹åŠ¨å‘è½¬æ¢ç²¾åº¦ã€‚è¿™æ˜¯ç”±äºå‘ä¸‹å–æ•´å¾—åˆ°çš„ä»ç„¶æ˜¯doubleï¼Œåœ¨ä¼ å‚æ—¶è¿˜æ˜¯ä¼šç»å†ä¸€æ¬¡ç²¾åº¦è½¬æ¢ï¼Œå¯èƒ½ä¼šæœ‰ä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚ï¼‰</strong></p>
</div>
<div id="ä¸¾ä¸€ä¸ªä¾‹å­" class="section level3">
<h3><span class="header-section-number">6.1.3</span> ä¸¾ä¸€ä¸ªä¾‹å­</h3>
<p>å…¶å®æ˜¯ä¸¤ä¸ªä¾‹å­ğŸŒ°ï¼Œåˆ†åˆ«æ˜¯ä¸€ç»´ï¼ˆå’ŒäºŒç»´å·®ä¸å¤šï¼‰å’Œä¸‰ç»´çš„å•ç²¾åº¦æµ®ç‚¹æ•°çº¹ç†çš„ä½¿ç”¨ã€‚å…¶ä½™æƒ…å†µå¤§åŒå°å¼‚ã€‚</p>
<div id="ä¸€ç»´çº¹ç†çš„æƒ…å†µ" class="section level4">
<h4><span class="header-section-number">6.1.3.1</span> ä¸€ç»´çº¹ç†çš„æƒ…å†µ</h4>
<div class="sourceCode" id="cb30"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb30-1"><a href="cuda-adv.html#cb30-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb30-2"><a href="cuda-adv.html#cb30-2"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb30-3"><a href="cuda-adv.html#cb30-3"></a><span class="pp">#include </span><span class="im">&lt;cuda_runtime.h&gt;</span></span>
<span id="cb30-4"><a href="cuda-adv.html#cb30-4"></a></span>
<span id="cb30-5"><a href="cuda-adv.html#cb30-5"></a>__global__ <span class="dt">void</span> FetchFrom1DTexture(cudaTextureObject_t tex,</span>
<span id="cb30-6"><a href="cuda-adv.html#cb30-6"></a>                                   <span class="dt">float</span>* position,</span>
<span id="cb30-7"><a href="cuda-adv.html#cb30-7"></a>                                   <span class="dt">float</span>* result,</span>
<span id="cb30-8"><a href="cuda-adv.html#cb30-8"></a>                                   <span class="dt">unsigned</span> <span class="dt">int</span> N){</span>
<span id="cb30-9"><a href="cuda-adv.html#cb30-9"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> id = blockIdx.x * blockDim.x + threadIdx.x;</span>
<span id="cb30-10"><a href="cuda-adv.html#cb30-10"></a>    <span class="cf">if</span>(id &lt; N){</span>
<span id="cb30-11"><a href="cuda-adv.html#cb30-11"></a>        <span class="co">//æ‹¾å–</span></span>
<span id="cb30-12"><a href="cuda-adv.html#cb30-12"></a>        <span class="co">//&lt;float&gt;æ˜¯c++æ¨¡æ¿</span></span>
<span id="cb30-13"><a href="cuda-adv.html#cb30-13"></a>        <span class="co">//è¿™é‡Œä¸è¯¦ç»†è§£é‡Šæ¨¡æ¿äº†ï¼Œæ€»ä¹‹åœ¨å°–æ‹¬å·é‡Œå¡«å†™çº¹ç†çš„ç±»å‹å°±å¯¹äº†</span></span>
<span id="cb30-14"><a href="cuda-adv.html#cb30-14"></a>        <span class="co">//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªtexture object (cudaTextureObject_t)</span></span>
<span id="cb30-15"><a href="cuda-adv.html#cb30-15"></a>        <span class="co">//ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦æ‹¾å–çš„ä½ç½®ã€‚</span></span>
<span id="cb30-16"><a href="cuda-adv.html#cb30-16"></a>        result[id] = tex1D&lt;<span class="dt">float</span>&gt;(tex, position[id]);</span>
<span id="cb30-17"><a href="cuda-adv.html#cb30-17"></a>    }</span>
<span id="cb30-18"><a href="cuda-adv.html#cb30-18"></a>}</span>
<span id="cb30-19"><a href="cuda-adv.html#cb30-19"></a></span>
<span id="cb30-20"><a href="cuda-adv.html#cb30-20"></a><span class="dt">int</span> main(){</span>
<span id="cb30-21"><a href="cuda-adv.html#cb30-21"></a>    <span class="co">//æˆ‘ä»¬è¦ä½¿ç”¨çš„çº¹ç†çš„åŸå§‹å€¼</span></span>
<span id="cb30-22"><a href="cuda-adv.html#cb30-22"></a>    <span class="dt">float</span>* resource = (<span class="dt">float</span>*)(malloc(<span class="dv">4</span>*<span class="kw">sizeof</span>(<span class="dt">float</span>)));</span>
<span id="cb30-23"><a href="cuda-adv.html#cb30-23"></a>    resource[<span class="dv">0</span>] = <span class="fl">1.0</span>;</span>
<span id="cb30-24"><a href="cuda-adv.html#cb30-24"></a>    resource[<span class="dv">1</span>] = <span class="fl">2.0</span>;</span>
<span id="cb30-25"><a href="cuda-adv.html#cb30-25"></a>    resource[<span class="dv">2</span>] = <span class="fl">3.0</span>;</span>
<span id="cb30-26"><a href="cuda-adv.html#cb30-26"></a>    resource[<span class="dv">3</span>] = <span class="fl">4.0</span>;</span>
<span id="cb30-27"><a href="cuda-adv.html#cb30-27"></a>    </span>
<span id="cb30-28"><a href="cuda-adv.html#cb30-28"></a>    <span class="co">//åˆ›å»ºä¸€ä¸ªCUDA Array</span></span>
<span id="cb30-29"><a href="cuda-adv.html#cb30-29"></a>    </span>
<span id="cb30-30"><a href="cuda-adv.html#cb30-30"></a>    <span class="co">//cudaChannelFormatDesc: </span></span>
<span id="cb30-31"><a href="cuda-adv.html#cb30-31"></a>    <span class="co">//  æè¿°Arrayé‡Œæ¯ä¸ªå…ƒç´ çš„æ ·å­ã€‚è¿™é‡Œæ¯ä¸ªå…ƒç´ æ˜¯floatã€‚</span></span>
<span id="cb30-32"><a href="cuda-adv.html#cb30-32"></a>    cudaChannelFormatDesc floatChannelDesc</span>
<span id="cb30-33"><a href="cuda-adv.html#cb30-33"></a>                      = cudaCreateChannelDesc&lt;<span class="dt">float</span>&gt;();</span>
<span id="cb30-34"><a href="cuda-adv.html#cb30-34"></a>    <span class="co">//å£°æ˜CUDA Array</span></span>
<span id="cb30-35"><a href="cuda-adv.html#cb30-35"></a>    cudaArray_t cuArray;</span>
<span id="cb30-36"><a href="cuda-adv.html#cb30-36"></a>    </span>
<span id="cb30-37"><a href="cuda-adv.html#cb30-37"></a>    <span class="co">//ä¸ºcuarrayåˆ†é…ç©ºé—´ã€‚ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯arrayåœ¨ç¬¬ä¸€ä¸ªç»´åº¦ä¸Šçš„é•¿åº¦ã€‚</span></span>
<span id="cb30-38"><a href="cuda-adv.html#cb30-38"></a>    <span class="co">//è¿™é‡Œé•¿åº¦å•ä½æ˜¯â€œä¸ªâ€ï¼Œ</span></span>
<span id="cb30-39"><a href="cuda-adv.html#cb30-39"></a>    <span class="co">//å› ä¸ºåœ¨floatChannelDescé‡Œå·²ç»æè¿°äº†æ¯ä¸ªå…ƒç´ çš„å¤§å°äº†ã€‚</span></span>
<span id="cb30-40"><a href="cuda-adv.html#cb30-40"></a>    <span class="co">//cudaMallocArrayå¯ä»¥åˆ†é…ä¸€ç»´æˆ–äºŒç»´çš„array</span></span>
<span id="cb30-41"><a href="cuda-adv.html#cb30-41"></a>    <span class="co">//ç¬¬å››ä¸ªå‚æ•°ç”¨äºæŒ‡å®šç¬¬äºŒä¸ªç»´åº¦çš„é•¿åº¦ï¼ˆå•ä½æ˜¯å¤šå°‘è¡Œ(hÃ¡ng)ï¼‰ï¼Œé»˜è®¤ä¸º0</span></span>
<span id="cb30-42"><a href="cuda-adv.html#cb30-42"></a>    cudaMallocArray(&amp;cuArray, &amp;floatChannelDesc, <span class="dv">4</span>);</span>
<span id="cb30-43"><a href="cuda-adv.html#cb30-43"></a>    </span>
<span id="cb30-44"><a href="cuda-adv.html#cb30-44"></a>    <span class="co">//å‘CUDA Arrayä¸­æ‹·è´æ•°æ®ã€‚</span></span>
<span id="cb30-45"><a href="cuda-adv.html#cb30-45"></a>    <span class="co">//cudaMemcpy2DToArrayç”¨äºå‘ä¸€ç»´å’ŒäºŒç»´Arrayä¸­æ‹·è´æ•°æ®ã€‚</span></span>
<span id="cb30-46"><a href="cuda-adv.html#cb30-46"></a>    <span class="co">//ä¸€ç»´Arrayå°±æ˜¯ç¬¬äºŒä¸ªç»´åº¦é•¿åº¦ä¸º0çš„äºŒç»´Array</span></span>
<span id="cb30-47"><a href="cuda-adv.html#cb30-47"></a>    <span class="co">//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›®æ ‡CUDA Array</span></span>
<span id="cb30-48"><a href="cuda-adv.html#cb30-48"></a>    <span class="co">//ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç›®æ ‡çš„xä½ç½®</span></span>
<span id="cb30-49"><a href="cuda-adv.html#cb30-49"></a>    <span class="co">//ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç›®æ ‡çš„yä½ç½®</span></span>
<span id="cb30-50"><a href="cuda-adv.html#cb30-50"></a>    <span class="co">//ç¬¬äºŒä¸ªå‚æ•°å’Œç¬¬ä¸‰ä¸ªå‚æ•°çš„æ„ä¹‰åœ¨äºå¯ä»¥åªæ›´æ–°Arrayçš„ä¸€éƒ¨åˆ†</span></span>
<span id="cb30-51"><a href="cuda-adv.html#cb30-51"></a>    <span class="co">//ç¬¬å››ä¸ªå‚æ•°æ˜¯è¢«æ‹·è´çš„æ•°æ®çš„æŒ‡é’ˆ</span></span>
<span id="cb30-52"><a href="cuda-adv.html#cb30-52"></a>    <span class="co">//ç¬¬äº”ä¸ªå‚æ•°æ˜¯æè¿°è¢«æ‹·è´çš„å†…å®¹æŒ‰ç…§æ¯ä¸€è¡Œå¤šå°‘byteæ¥æ’åˆ—</span></span>
<span id="cb30-53"><a href="cuda-adv.html#cb30-53"></a>    <span class="co">//ç¬¬å…­ä¸ªå‚æ•°æ˜¯ç›®æ ‡ä½ç½®æ¯ä¸€è¡Œæ‹·è´å¤šå°‘byte</span></span>
<span id="cb30-54"><a href="cuda-adv.html#cb30-54"></a>    <span class="co">//ç¬¬ä¸ƒä¸ªå‚æ•°æ˜¯ä¸€å…±æ‹·è´å¤šå°‘è¡Œ</span></span>
<span id="cb30-55"><a href="cuda-adv.html#cb30-55"></a>    <span class="co">//ç¬¬å…«ä¸ªå‚æ•°æ˜¯æ‹·è´æ–¹å‘ï¼Œè¿™é‡Œæ˜¯ä»ä¸»æœºå†…å­˜åˆ°æ˜¾å¡å†…å­˜ã€‚åŸå› å‰é¢è®²è¿‡ã€‚</span></span>
<span id="cb30-56"><a href="cuda-adv.html#cb30-56"></a>    <span class="co">//å¯ä»¥é€šè¿‡åæ–‡çš„å›¾ç‰‡è¯¦ç»†äº†è§£è¿™ä¸ªå‡½æ•°çš„å·¥ä½œæ–¹å¼ã€‚</span></span>
<span id="cb30-57"><a href="cuda-adv.html#cb30-57"></a>    cudaMemcpy2DToArray(cuArray, <span class="dv">0</span>, <span class="dv">0</span>,  resource, <span class="dv">4</span>*<span class="kw">sizeof</span>(<span class="dt">float</span>),</span>
<span id="cb30-58"><a href="cuda-adv.html#cb30-58"></a>                        <span class="dv">4</span>*<span class="kw">sizeof</span>(<span class="dt">float</span>), <span class="dv">1</span>, cudaMemcpyHostToDevice);</span>
<span id="cb30-59"><a href="cuda-adv.html#cb30-59"></a>    <span class="co">//å…¶å®æ‹·è´å®Œä»¥åä¸»æœºå†…å­˜é‡Œçš„resourceå·²ç»æ²¡ç”¨äº†ï¼Œå¯ä»¥ç°åœ¨å°±freeæ‰ã€‚</span></span>
<span id="cb30-60"><a href="cuda-adv.html#cb30-60"></a>    </span>
<span id="cb30-61"><a href="cuda-adv.html#cb30-61"></a>    </span>
<span id="cb30-62"><a href="cuda-adv.html#cb30-62"></a>    <span class="co">//æè¿°è¦æˆä¸ºçº¹ç†çš„ä¸œè¥¿æ˜¯ä¸ªå•¥</span></span>
<span id="cb30-63"><a href="cuda-adv.html#cb30-63"></a>    <span class="co">//resTypeè®¾ç½®ä¸ºcudaResourceTypeArrayï¼Œè¡¨æ˜è¦ä»ä¸€ä¸ªArrayæ¥æ„å»ºçº¹ç†</span></span>
<span id="cb30-64"><a href="cuda-adv.html#cb30-64"></a>    <span class="co">//res.array.arrayè®¾ç½®æˆæˆ‘ä»¬åˆšåˆšå‡†å¤‡å¥½çš„Array</span></span>
<span id="cb30-65"><a href="cuda-adv.html#cb30-65"></a>    <span class="kw">struct</span> cudaResourceDesc resDesc;</span>
<span id="cb30-66"><a href="cuda-adv.html#cb30-66"></a>    memset(&amp;resDesc, <span class="dv">0</span>, <span class="kw">sizeof</span>(resDesc));</span>
<span id="cb30-67"><a href="cuda-adv.html#cb30-67"></a>    resDesc.resType = cudaResourceTypeArray;</span>
<span id="cb30-68"><a href="cuda-adv.html#cb30-68"></a>    resDesc.res.array.array = cuArray;</span>
<span id="cb30-69"><a href="cuda-adv.html#cb30-69"></a>    </span>
<span id="cb30-70"><a href="cuda-adv.html#cb30-70"></a>    <span class="co">//æè¿°æˆ‘ä»¬è¦çš„çº¹ç†æ˜¯ä¸ªå•¥æ ·å­</span></span>
<span id="cb30-71"><a href="cuda-adv.html#cb30-71"></a>    <span class="kw">struct</span> cudaTextureDesc texDesc;</span>
<span id="cb30-72"><a href="cuda-adv.html#cb30-72"></a>    memset(&amp;texDesc, <span class="dv">0</span>, <span class="kw">sizeof</span>(texDesc));</span>
<span id="cb30-73"><a href="cuda-adv.html#cb30-73"></a>    <span class="co">//addressModeå¯å–çš„å€¼æœ‰ï¼š</span></span>
<span id="cb30-74"><a href="cuda-adv.html#cb30-74"></a>    <span class="co">//  cudaAddressModeWrap</span></span>
<span id="cb30-75"><a href="cuda-adv.html#cb30-75"></a>    <span class="co">//  cudaAddressModeClamp</span></span>
<span id="cb30-76"><a href="cuda-adv.html#cb30-76"></a>    <span class="co">//  cudaAddressModeMirror</span></span>
<span id="cb30-77"><a href="cuda-adv.html#cb30-77"></a>    <span class="co">//  cudaAddressModeBorder</span></span>
<span id="cb30-78"><a href="cuda-adv.html#cb30-78"></a>    <span class="co">//è¯¦æƒ…è§ä¸Šæ–‡æè¿°</span></span>
<span id="cb30-79"><a href="cuda-adv.html#cb30-79"></a>    <span class="co">//addressModeæ˜¯é•¿åº¦ä¸º3çš„æ•°ç»„ï¼Œåˆ†åˆ«å¯¹åº”ä¸‰ä¸ªç»´åº¦ã€‚</span></span>
<span id="cb30-80"><a href="cuda-adv.html#cb30-80"></a>    <span class="co">//è¿™é‡Œæ˜¯ä¸€ç»´æ‰€ä»¥åªç”¨ç¬¬ä¸€ä¸ªã€‚</span></span>
<span id="cb30-81"><a href="cuda-adv.html#cb30-81"></a>    texDesc.addressMode[<span class="dv">0</span>]   = cudaAddressModeWrap;</span>
<span id="cb30-82"><a href="cuda-adv.html#cb30-82"></a>    <span class="co">//filterModeå¯å–çš„å€¼æœ‰ï¼š</span></span>
<span id="cb30-83"><a href="cuda-adv.html#cb30-83"></a>    <span class="co">//  cudaFilterModeLinear  çº¿æ€§æ’å€¼æ¨¡å¼</span></span>
<span id="cb30-84"><a href="cuda-adv.html#cb30-84"></a>    <span class="co">//  cudaFilterModePoint   å–æœ€è¿‘ç‚¹æ¨¡å¼</span></span>
<span id="cb30-85"><a href="cuda-adv.html#cb30-85"></a>    texDesc.filterMode       = cudaFilterModeLinear;</span>
<span id="cb30-86"><a href="cuda-adv.html#cb30-86"></a>    <span class="co">//readModeå¯å–çš„å€¼æœ‰ï¼š</span></span>
<span id="cb30-87"><a href="cuda-adv.html#cb30-87"></a>    <span class="co">//  cudaReadModeElementType  Arrayæ˜¯ä»€ä¹ˆç±»å‹æ‹¾å–å‡ºæ¥å°±æ˜¯ä»€ä¹ˆç±»å‹</span></span>
<span id="cb30-88"><a href="cuda-adv.html#cb30-88"></a>    <span class="co">//  cudaReadModeNormalizedFloat  è¿›è¡Œå½’ä¸€åŒ–</span></span>
<span id="cb30-89"><a href="cuda-adv.html#cb30-89"></a>    <span class="co">//æ³¨æ„ï¼Œåªæœ‰8ä½æˆ–16ä½æ•´æ•°æ”¯æŒå½’ä¸€åŒ–ï¼Œå…¶ä»–ç±»å‹æ¯”å¦‚int/floatåˆ™ä¸æ”¯æŒã€‚</span></span>
<span id="cb30-90"><a href="cuda-adv.html#cb30-90"></a>    texDesc.readMode         = cudaReadModeElementType;</span>
<span id="cb30-91"><a href="cuda-adv.html#cb30-91"></a>    <span class="co">//æ˜¯å¦å¯¹åæ ‡å½’ä¸€åŒ–åˆ°[0,1). 1è¡¨ç¤ºè¿›è¡Œå½’ä¸€åŒ–ã€‚</span></span>
<span id="cb30-92"><a href="cuda-adv.html#cb30-92"></a>    texDesc.normalizedCoords = <span class="dv">1</span>;</span>
<span id="cb30-93"><a href="cuda-adv.html#cb30-93"></a>    </span>
<span id="cb30-94"><a href="cuda-adv.html#cb30-94"></a>    <span class="co">//å£°æ˜å¹¶åˆ›å»ºçº¹ç†</span></span>
<span id="cb30-95"><a href="cuda-adv.html#cb30-95"></a>    <span class="co">//è¿™é‡Œç›¸å½“äºå°†çº¹ç†ç»‘å®šåˆ°ä¹‹å‰åˆ›å»ºçš„cuArray</span></span>
<span id="cb30-96"><a href="cuda-adv.html#cb30-96"></a>    <span class="co">//æ‰€ä»¥ä¸èƒ½é‡Šæ”¾æ‰cuArray</span></span>
<span id="cb30-97"><a href="cuda-adv.html#cb30-97"></a>    cudaTextureObject_t tex1DObj;</span>
<span id="cb30-98"><a href="cuda-adv.html#cb30-98"></a>    cudaCreateTextureObject(&amp;tex1DObj, &amp;resDesc, &amp;texDesc, NULL);</span>
<span id="cb30-99"><a href="cuda-adv.html#cb30-99"></a>    </span>
<span id="cb30-100"><a href="cuda-adv.html#cb30-100"></a>    <span class="co">//æˆ‘ä»¬æƒ³è¦æ‹¾å–çš„çº¹ç†çš„åæ ‡ã€‚</span></span>
<span id="cb30-101"><a href="cuda-adv.html#cb30-101"></a>    <span class="dt">float</span>* position = (<span class="dt">float</span>*)(malloc(<span class="dv">60</span>*<span class="kw">sizeof</span>(<span class="dt">float</span>)));</span>
<span id="cb30-102"><a href="cuda-adv.html#cb30-102"></a>    <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">60</span>; i++){</span>
<span id="cb30-103"><a href="cuda-adv.html#cb30-103"></a>        position[i] = -<span class="fl">1.0</span> + (<span class="dt">float</span>)(i)/<span class="fl">20.0</span>;</span>
<span id="cb30-104"><a href="cuda-adv.html#cb30-104"></a>    }</span>
<span id="cb30-105"><a href="cuda-adv.html#cb30-105"></a>    </span>
<span id="cb30-106"><a href="cuda-adv.html#cb30-106"></a>    <span class="dt">float</span>* result = (<span class="dt">float</span>*)(malloc(<span class="dv">60</span>*<span class="kw">sizeof</span>(<span class="dt">float</span>)));</span>
<span id="cb30-107"><a href="cuda-adv.html#cb30-107"></a>    </span>
<span id="cb30-108"><a href="cuda-adv.html#cb30-108"></a>    <span class="dt">float</span>* cuposition;</span>
<span id="cb30-109"><a href="cuda-adv.html#cb30-109"></a>    <span class="dt">float</span>* curesult;</span>
<span id="cb30-110"><a href="cuda-adv.html#cb30-110"></a>    cudaMalloc(&amp;cuposition, <span class="dv">60</span>*<span class="kw">sizeof</span>(<span class="dt">float</span>));</span>
<span id="cb30-111"><a href="cuda-adv.html#cb30-111"></a>    cudaMalloc(&amp;curesult, <span class="dv">60</span>*<span class="kw">sizeof</span>(<span class="dt">float</span>));</span>
<span id="cb30-112"><a href="cuda-adv.html#cb30-112"></a>    cudaMemcpy(cuposition, position, <span class="dv">60</span>*<span class="kw">sizeof</span>(<span class="dt">float</span>),</span>
<span id="cb30-113"><a href="cuda-adv.html#cb30-113"></a>               cudaMemcpyHostToDevice);</span>
<span id="cb30-114"><a href="cuda-adv.html#cb30-114"></a>    </span>
<span id="cb30-115"><a href="cuda-adv.html#cb30-115"></a>    FetchFrom1DTexture&lt;&lt;&lt;<span class="dv">1</span>, <span class="dv">60</span>&gt;&gt;&gt;(tex1DObj, cuposition, curesult, <span class="dv">60</span>);</span>
<span id="cb30-116"><a href="cuda-adv.html#cb30-116"></a>    </span>
<span id="cb30-117"><a href="cuda-adv.html#cb30-117"></a>    cudaMemcpy(result, curesult, <span class="dv">60</span>*<span class="kw">sizeof</span>(<span class="dt">float</span>),</span>
<span id="cb30-118"><a href="cuda-adv.html#cb30-118"></a>               cudaMemcpyDeviceToHost);</span>
<span id="cb30-119"><a href="cuda-adv.html#cb30-119"></a>    </span>
<span id="cb30-120"><a href="cuda-adv.html#cb30-120"></a>    <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">60</span>; i++){</span>
<span id="cb30-121"><a href="cuda-adv.html#cb30-121"></a>        printf(<span class="st">&quot;Texel at position (%- 5.3f) is %5.3f </span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb30-122"><a href="cuda-adv.html#cb30-122"></a>               position[i], result[i]);</span>
<span id="cb30-123"><a href="cuda-adv.html#cb30-123"></a>    }</span>
<span id="cb30-124"><a href="cuda-adv.html#cb30-124"></a>    </span>
<span id="cb30-125"><a href="cuda-adv.html#cb30-125"></a>    cudaFree(curesult);</span>
<span id="cb30-126"><a href="cuda-adv.html#cb30-126"></a>    cudaFree(cuposition);</span>
<span id="cb30-127"><a href="cuda-adv.html#cb30-127"></a>    </span>
<span id="cb30-128"><a href="cuda-adv.html#cb30-128"></a>    free(result);</span>
<span id="cb30-129"><a href="cuda-adv.html#cb30-129"></a>    free(position);</span>
<span id="cb30-130"><a href="cuda-adv.html#cb30-130"></a>    free(resource);</span>
<span id="cb30-131"><a href="cuda-adv.html#cb30-131"></a>    </span>
<span id="cb30-132"><a href="cuda-adv.html#cb30-132"></a>    <span class="co">//ä¸å†ä½¿ç”¨çš„çº¹ç†è¦é”€æ¯æ‰</span></span>
<span id="cb30-133"><a href="cuda-adv.html#cb30-133"></a>    cudaDestroyTextureObject(tex1DObj);</span>
<span id="cb30-134"><a href="cuda-adv.html#cb30-134"></a>    <span class="co">//Arrayç”¨å®Œäº†ä¹Ÿè¦é‡Šæ”¾</span></span>
<span id="cb30-135"><a href="cuda-adv.html#cb30-135"></a>    cudaFreeArray(cuArray);</span>
<span id="cb30-136"><a href="cuda-adv.html#cb30-136"></a>    </span>
<span id="cb30-137"><a href="cuda-adv.html#cb30-137"></a>}</span></code></pre></div>
<p>ç”»å›¾æ¥è¡¨ç¤ºä¸€ä¸‹ç»“æœçš„è¯</p>
<p><img src="bookdown_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>ä¸Šå›¾ä¸­çº¢ç‚¹æ˜¯æˆ‘ä»¬è®¾å®šçš„å€¼ï¼Œç”±äºè®¾ç½®äº†<code>texDesc.normalizedCoords = 1;</code>ï¼Œ[0,4)è¢«æ˜ å°„åˆ°äº†[0,1)ï¼Œç›¸åº”çš„ä½ç½®{0.5, 1.5, 2.5, 3.5}å°±è¢«æ˜ å°„åˆ°äº†{1/8, 3/8, 5/8, 7/8}ã€‚ç”±äºè®¾ç½®äº†<code>texDesc.addressMode[0] = cudaAddressModeWrap;</code>ï¼Œè¶…è¿‡[0,1)èŒƒå›´çš„ä½ç½®å¾—åˆ°äº†ä»[0,1)å¹³ç§»è¿‡å»çš„å€¼ã€‚</p>
<div class="figure"><span id="fig:fig2"></span>
<img src="figs/memcpy2D.svg" alt="å›¾è§£cudaMemcpy2DToArray" width="90%" />
<p class="caption">
å›¾ 6.1: å›¾è§£cudaMemcpy2DToArray
</p>
</div>
<p>äºŒç»´çº¹ç†ä¸ä¸Šè¿°è¿‡ç¨‹å¤§åŒå°å¼‚ã€‚</p>
</div>
<div id="ä¸‰ç»´çº¹ç†çš„æƒ…å†µ" class="section level4">
<h4><span class="header-section-number">6.1.3.2</span> ä¸‰ç»´çº¹ç†çš„æƒ…å†µ</h4>
<p>ä¸‰ç»´çº¹ç†åˆ™æœ‰æ‰€ä¸åŒã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œæˆ‘ä»¬ä½¿ç”¨float2ä½œä¸ºçº¹ç†çš„ç±»å‹ã€‚</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb31-1"><a href="cuda-adv.html#cb31-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb31-2"><a href="cuda-adv.html#cb31-2"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb31-3"><a href="cuda-adv.html#cb31-3"></a><span class="pp">#include </span><span class="im">&lt;cuda_runtime.h&gt;</span></span>
<span id="cb31-4"><a href="cuda-adv.html#cb31-4"></a></span>
<span id="cb31-5"><a href="cuda-adv.html#cb31-5"></a>__global__ <span class="dt">void</span> FetchFrom1DTexture(cudaTextureObject_t tex,</span>
<span id="cb31-6"><a href="cuda-adv.html#cb31-6"></a>                                   float3* position,</span>
<span id="cb31-7"><a href="cuda-adv.html#cb31-7"></a>                                   float2* result,</span>
<span id="cb31-8"><a href="cuda-adv.html#cb31-8"></a>                                   <span class="dt">unsigned</span> <span class="dt">int</span> N){</span>
<span id="cb31-9"><a href="cuda-adv.html#cb31-9"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> id = blockIdx.x * blockDim.x + threadIdx.x;</span>
<span id="cb31-10"><a href="cuda-adv.html#cb31-10"></a>    <span class="cf">if</span>(id &lt; N){</span>
<span id="cb31-11"><a href="cuda-adv.html#cb31-11"></a>        <span class="co">//æ‹¾å–</span></span>
<span id="cb31-12"><a href="cuda-adv.html#cb31-12"></a>        <span class="co">//tex3Dçš„åä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸ºç¬¬ä¸€ï¼Œç¬¬äºŒå’Œç¬¬ä¸‰ä¸ªç»´åº¦ä¸Šçš„åæ ‡</span></span>
<span id="cb31-13"><a href="cuda-adv.html#cb31-13"></a>        result[id] = tex3D&lt;float2&gt;(tex, position[id].x,</span>
<span id="cb31-14"><a href="cuda-adv.html#cb31-14"></a>                                        position[id].y,</span>
<span id="cb31-15"><a href="cuda-adv.html#cb31-15"></a>                                        position[id].z);</span>
<span id="cb31-16"><a href="cuda-adv.html#cb31-16"></a>    }</span>
<span id="cb31-17"><a href="cuda-adv.html#cb31-17"></a>}</span>
<span id="cb31-18"><a href="cuda-adv.html#cb31-18"></a></span>
<span id="cb31-19"><a href="cuda-adv.html#cb31-19"></a><span class="dt">int</span> main(){</span>
<span id="cb31-20"><a href="cuda-adv.html#cb31-20"></a>    <span class="co">//æˆ‘ä»¬è¦ä½¿ç”¨çš„çº¹ç†çš„åŸå§‹å€¼</span></span>
<span id="cb31-21"><a href="cuda-adv.html#cb31-21"></a>    float2* resource = (float2*)(malloc(<span class="dv">8</span>*<span class="kw">sizeof</span>(float2)));</span>
<span id="cb31-22"><a href="cuda-adv.html#cb31-22"></a>    <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">8</span>; i++){</span>
<span id="cb31-23"><a href="cuda-adv.html#cb31-23"></a>        resource[i].x = <span class="fl">1.0</span> + (<span class="dt">float</span>)i;</span>
<span id="cb31-24"><a href="cuda-adv.html#cb31-24"></a>        resource[i].y = -<span class="fl">2.0</span> - <span class="fl">2.0</span> * (<span class="dt">float</span>)i;</span>
<span id="cb31-25"><a href="cuda-adv.html#cb31-25"></a>        <span class="co">//é¡ºä¾¿ä¸€æï¼š</span></span>
<span id="cb31-26"><a href="cuda-adv.html#cb31-26"></a>        <span class="co">//float2çš„ä¸¤ä¸ªåˆ†é‡æ˜¯xå’Œy</span></span>
<span id="cb31-27"><a href="cuda-adv.html#cb31-27"></a>        <span class="co">//float3çš„ä¸‰ä¸ªåˆ†é‡æ˜¯xï¼Œyå’Œz</span></span>
<span id="cb31-28"><a href="cuda-adv.html#cb31-28"></a>        <span class="co">//float4çš„å››ä¸ªåˆ†é‡æ˜¯xï¼Œyï¼Œzå’Œw</span></span>
<span id="cb31-29"><a href="cuda-adv.html#cb31-29"></a>    }</span>
<span id="cb31-30"><a href="cuda-adv.html#cb31-30"></a>    </span>
<span id="cb31-31"><a href="cuda-adv.html#cb31-31"></a>    <span class="co">//åˆ›å»ºä¸€ä¸ªCUDA Array</span></span>
<span id="cb31-32"><a href="cuda-adv.html#cb31-32"></a>    <span class="co">//cudaChannelFormatDesc: </span></span>
<span id="cb31-33"><a href="cuda-adv.html#cb31-33"></a>    <span class="co">//  æè¿°Arrayé‡Œæ¯ä¸ªå…ƒç´ çš„æ ·å­ã€‚è¿™é‡Œæ¯ä¸ªå…ƒç´ æ˜¯float2ã€‚</span></span>
<span id="cb31-34"><a href="cuda-adv.html#cb31-34"></a>    cudaChannelFormatDesc floatChannelDesc</span>
<span id="cb31-35"><a href="cuda-adv.html#cb31-35"></a>                       = cudaCreateChannelDesc&lt;float2&gt;();</span>
<span id="cb31-36"><a href="cuda-adv.html#cb31-36"></a>    </span>
<span id="cb31-37"><a href="cuda-adv.html#cb31-37"></a>    <span class="co">//cudaExtentæ˜¯ç”¨æ¥æè¿°arrayçš„å½¢çŠ¶çš„</span></span>
<span id="cb31-38"><a href="cuda-adv.html#cb31-38"></a>    <span class="co">//ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯å®½(x)ï¼Œé«˜(y)ï¼Œå’Œæ·±(z)</span></span>
<span id="cb31-39"><a href="cuda-adv.html#cb31-39"></a>    cudaExtent ext = make_cudaExtent(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>);</span>
<span id="cb31-40"><a href="cuda-adv.html#cb31-40"></a>    <span class="co">//å£°æ˜CUDA Array</span></span>
<span id="cb31-41"><a href="cuda-adv.html#cb31-41"></a>    cudaArray_t cuArray;</span>
<span id="cb31-42"><a href="cuda-adv.html#cb31-42"></a>    <span class="co">//ä¸ºcuArrayåˆ†é…ç©ºé—´ã€‚</span></span>
<span id="cb31-43"><a href="cuda-adv.html#cb31-43"></a>    cudaMalloc3DArray(&amp;cuArray, &amp;floatChannelDesc, ext);</span>
<span id="cb31-44"><a href="cuda-adv.html#cb31-44"></a></span>
<span id="cb31-45"><a href="cuda-adv.html#cb31-45"></a>    <span class="co">//ç”±äºä¸‰ç»´æ‹·è´å‚æ•°æ¯”è¾ƒå¤æ‚</span></span>
<span id="cb31-46"><a href="cuda-adv.html#cb31-46"></a>    <span class="co">//æ‰€ä»¥CUDAè®¾è®¡äº†ä¸€ä¸ªç±»å‹ç”¨äºè¡¨è¾¾å‚æ•°</span></span>
<span id="cb31-47"><a href="cuda-adv.html#cb31-47"></a>    cudaMemcpy3DParms cpy3d={<span class="dv">0</span>};</span>
<span id="cb31-48"><a href="cuda-adv.html#cb31-48"></a>    <span class="co">//çº¹ç†æ¥æºäºresourceæ•°ç»„</span></span>
<span id="cb31-49"><a href="cuda-adv.html#cb31-49"></a>    cpy3d.srcPtr.ptr = resource;</span>
<span id="cb31-50"><a href="cuda-adv.html#cb31-50"></a>    <span class="co">//æ¥æºæ•°ç»„ä¸­æ¯ä¸¤ä¸ªfloat2ç®—ä½œä¸€è¡Œ</span></span>
<span id="cb31-51"><a href="cuda-adv.html#cb31-51"></a>    cpy3d.srcPtr.pitch = <span class="dv">2</span>*<span class="kw">sizeof</span>(float2);</span>
<span id="cb31-52"><a href="cuda-adv.html#cb31-52"></a>    <span class="co">//æ¥æºæ•°ç»„æ¯è¡Œå–ä¸¤ä¸ªå…ƒç´ </span></span>
<span id="cb31-53"><a href="cuda-adv.html#cb31-53"></a>    cpy3d.srcPtr.xsize = <span class="dv">2</span>;</span>
<span id="cb31-54"><a href="cuda-adv.html#cb31-54"></a>    <span class="co">//æ¥æºæ•°ç»„æ¯ä¸¤è¡Œç»„æˆä¸€å±‚</span></span>
<span id="cb31-55"><a href="cuda-adv.html#cb31-55"></a>    cpy3d.srcPtr.ysize = <span class="dv">2</span>;</span>
<span id="cb31-56"><a href="cuda-adv.html#cb31-56"></a>    <span class="co">//æ‹·è´çš„ç›®çš„åœ°æ˜¯cuArrayæ•°ç»„</span></span>
<span id="cb31-57"><a href="cuda-adv.html#cb31-57"></a>    cpy3d.dstArray = cuArray;</span>
<span id="cb31-58"><a href="cuda-adv.html#cb31-58"></a>    <span class="co">//ç›®æ ‡é‡Œé¢åœ¨ä¸‰ä¸ªç»´åº¦ä¸Šå„æœ‰å‡ ä¸ªå…ƒç´ ï¼Œä¹Ÿæ˜¯ç”¨cudaExtent</span></span>
<span id="cb31-59"><a href="cuda-adv.html#cb31-59"></a>    <span class="co">//è¿™é‡Œè¦å¤åˆ¶åˆ°æ•´ä¸ªarrayï¼Œæ‰€ä»¥é‡ç”¨äº†å‰é¢å®šä¹‰çš„ext</span></span>
<span id="cb31-60"><a href="cuda-adv.html#cb31-60"></a>    cpy3d.extent = ext;</span>
<span id="cb31-61"><a href="cuda-adv.html#cb31-61"></a>    <span class="co">//ä»ä¸»æœºå†…å­˜æ‹·è´åˆ°æ˜¾å­˜</span></span>
<span id="cb31-62"><a href="cuda-adv.html#cb31-62"></a>    cpy3d.kind = cudaMemcpyHostToDevice;</span>
<span id="cb31-63"><a href="cuda-adv.html#cb31-63"></a>    <span class="co">//ä¸‰ç»´æ‹·è´ä¹Ÿå¯ä»¥åƒäºŒç»´æ‹·è´ä¸€æ ·è®¾ç½®èµ·ç‚¹ï¼Œè¿™é‡Œå°±ä¸è¯¦è¿°äº†</span></span>
<span id="cb31-64"><a href="cuda-adv.html#cb31-64"></a>    <span class="co">//å¯ä»¥å‚è€ƒcuda Toolkit 11.0.3çš„æ–‡æ¡£é‡Œ</span></span>
<span id="cb31-65"><a href="cuda-adv.html#cb31-65"></a>    <span class="co">//cuda runtime APIä¸­5.9èŠ‚å…³äºcudaMemcpy3Dçš„è¯´æ˜</span></span>
<span id="cb31-66"><a href="cuda-adv.html#cb31-66"></a>    cudaMemcpy3D(&amp;cpy3d);</span>
<span id="cb31-67"><a href="cuda-adv.html#cb31-67"></a>    </span>
<span id="cb31-68"><a href="cuda-adv.html#cb31-68"></a></span>
<span id="cb31-69"><a href="cuda-adv.html#cb31-69"></a>    <span class="kw">struct</span> cudaResourceDesc resDesc;</span>
<span id="cb31-70"><a href="cuda-adv.html#cb31-70"></a>    memset(&amp;resDesc, <span class="dv">0</span>, <span class="kw">sizeof</span>(resDesc));</span>
<span id="cb31-71"><a href="cuda-adv.html#cb31-71"></a>    resDesc.resType = cudaResourceTypeArray;</span>
<span id="cb31-72"><a href="cuda-adv.html#cb31-72"></a>    resDesc.res.array.array = cuArray;</span>
<span id="cb31-73"><a href="cuda-adv.html#cb31-73"></a>    </span>
<span id="cb31-74"><a href="cuda-adv.html#cb31-74"></a>    <span class="kw">struct</span> cudaTextureDesc texDesc;</span>
<span id="cb31-75"><a href="cuda-adv.html#cb31-75"></a>    memset(&amp;texDesc, <span class="dv">0</span>, <span class="kw">sizeof</span>(texDesc));</span>
<span id="cb31-76"><a href="cuda-adv.html#cb31-76"></a>    <span class="co">//è¿™å›æˆ‘ä»¬ä½¿ç”¨â€œè¾¹ç•Œâ€æ¨¡å¼</span></span>
<span id="cb31-77"><a href="cuda-adv.html#cb31-77"></a>    <span class="co">//å› ä¸ºæ˜¯ä¸‰ç»´çº¹ç†ï¼Œæ‰€ä»¥ä¸‰ä¸ªéƒ½è¦è®¾ç½®</span></span>
<span id="cb31-78"><a href="cuda-adv.html#cb31-78"></a>    texDesc.addressMode[<span class="dv">0</span>]   = cudaAddressModeBorder;</span>
<span id="cb31-79"><a href="cuda-adv.html#cb31-79"></a>    texDesc.addressMode[<span class="dv">1</span>]   = cudaAddressModeBorder;</span>
<span id="cb31-80"><a href="cuda-adv.html#cb31-80"></a>    texDesc.addressMode[<span class="dv">2</span>]   = cudaAddressModeBorder;</span>
<span id="cb31-81"><a href="cuda-adv.html#cb31-81"></a></span>
<span id="cb31-82"><a href="cuda-adv.html#cb31-82"></a>    texDesc.filterMode       = cudaFilterModeLinear;</span>
<span id="cb31-83"><a href="cuda-adv.html#cb31-83"></a>    texDesc.readMode         = cudaReadModeElementType;</span>
<span id="cb31-84"><a href="cuda-adv.html#cb31-84"></a>    <span class="co">//è¿™æ¬¡ä¸åšå½’ä¸€åŒ–</span></span>
<span id="cb31-85"><a href="cuda-adv.html#cb31-85"></a>    texDesc.normalizedCoords = <span class="dv">0</span>;</span>
<span id="cb31-86"><a href="cuda-adv.html#cb31-86"></a>    </span>
<span id="cb31-87"><a href="cuda-adv.html#cb31-87"></a>    <span class="co">//å£°æ˜å¹¶åˆ›å»ºçº¹ç†</span></span>
<span id="cb31-88"><a href="cuda-adv.html#cb31-88"></a>    cudaTextureObject_t tex3DObj;</span>
<span id="cb31-89"><a href="cuda-adv.html#cb31-89"></a>    cudaCreateTextureObject(&amp;tex3DObj, &amp;resDesc, &amp;texDesc, NULL);</span>
<span id="cb31-90"><a href="cuda-adv.html#cb31-90"></a>    </span>
<span id="cb31-91"><a href="cuda-adv.html#cb31-91"></a>    <span class="co">//æˆ‘ä»¬æƒ³è¦æ‹¾å–çš„çº¹ç†çš„åæ ‡ã€‚</span></span>
<span id="cb31-92"><a href="cuda-adv.html#cb31-92"></a>    float3* position = (float3*)(malloc(<span class="dv">64</span>*<span class="kw">sizeof</span>(float3)));</span>
<span id="cb31-93"><a href="cuda-adv.html#cb31-93"></a>    <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">4</span>; i++){</span>
<span id="cb31-94"><a href="cuda-adv.html#cb31-94"></a>        <span class="cf">for</span>(<span class="dt">int</span> j = <span class="dv">0</span>; j &lt; <span class="dv">4</span>; j++){</span>
<span id="cb31-95"><a href="cuda-adv.html#cb31-95"></a>            <span class="cf">for</span>(<span class="dt">int</span> k = <span class="dv">0</span>; k &lt; <span class="dv">4</span>; k++){</span>
<span id="cb31-96"><a href="cuda-adv.html#cb31-96"></a>                <span class="dt">int</span> id = i + j*<span class="dv">4</span> + k*<span class="dv">16</span>;</span>
<span id="cb31-97"><a href="cuda-adv.html#cb31-97"></a>                position[id].x = (<span class="dt">float</span>)i - <span class="fl">0.5</span>;</span>
<span id="cb31-98"><a href="cuda-adv.html#cb31-98"></a>                position[id].y = (<span class="dt">float</span>)j - <span class="fl">0.5</span>;</span>
<span id="cb31-99"><a href="cuda-adv.html#cb31-99"></a>                position[id].z = (<span class="dt">float</span>)k - <span class="fl">0.5</span>;</span>
<span id="cb31-100"><a href="cuda-adv.html#cb31-100"></a>            }</span>
<span id="cb31-101"><a href="cuda-adv.html#cb31-101"></a>        }</span>
<span id="cb31-102"><a href="cuda-adv.html#cb31-102"></a>    }</span>
<span id="cb31-103"><a href="cuda-adv.html#cb31-103"></a>    </span>
<span id="cb31-104"><a href="cuda-adv.html#cb31-104"></a>    float2* result = (float2*)(malloc(<span class="dv">64</span>*<span class="kw">sizeof</span>(float2)));</span>
<span id="cb31-105"><a href="cuda-adv.html#cb31-105"></a>    float3* cuposition;</span>
<span id="cb31-106"><a href="cuda-adv.html#cb31-106"></a>    float2* curesult;</span>
<span id="cb31-107"><a href="cuda-adv.html#cb31-107"></a>    cudaMalloc(&amp;cuposition, <span class="dv">64</span>*<span class="kw">sizeof</span>(float3));</span>
<span id="cb31-108"><a href="cuda-adv.html#cb31-108"></a>    cudaMalloc(&amp;curesult, <span class="dv">64</span>*<span class="kw">sizeof</span>(float2));</span>
<span id="cb31-109"><a href="cuda-adv.html#cb31-109"></a>    cudaMemcpy(cuposition, position, <span class="dv">64</span>*<span class="kw">sizeof</span>(float3),</span>
<span id="cb31-110"><a href="cuda-adv.html#cb31-110"></a>               cudaMemcpyHostToDevice);</span>
<span id="cb31-111"><a href="cuda-adv.html#cb31-111"></a>    </span>
<span id="cb31-112"><a href="cuda-adv.html#cb31-112"></a>    FetchFrom1DTexture&lt;&lt;&lt;<span class="dv">1</span>, <span class="dv">64</span>&gt;&gt;&gt;(tex3DObj, cuposition, curesult, <span class="dv">64</span>);</span>
<span id="cb31-113"><a href="cuda-adv.html#cb31-113"></a>    </span>
<span id="cb31-114"><a href="cuda-adv.html#cb31-114"></a>    cudaMemcpy(result, curesult, <span class="dv">64</span>*<span class="kw">sizeof</span>(float2),</span>
<span id="cb31-115"><a href="cuda-adv.html#cb31-115"></a>               cudaMemcpyDeviceToHost);</span>
<span id="cb31-116"><a href="cuda-adv.html#cb31-116"></a>    <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">4</span>; i++){</span>
<span id="cb31-117"><a href="cuda-adv.html#cb31-117"></a>        <span class="cf">for</span>(<span class="dt">int</span> j = <span class="dv">0</span>; j &lt; <span class="dv">4</span>; j++){</span>
<span id="cb31-118"><a href="cuda-adv.html#cb31-118"></a>            <span class="cf">for</span>(<span class="dt">int</span> k = <span class="dv">0</span>; k &lt; <span class="dv">4</span>; k++){</span>
<span id="cb31-119"><a href="cuda-adv.html#cb31-119"></a>                <span class="dt">int</span> id = i + j*<span class="dv">4</span> + k*<span class="dv">16</span>;</span>
<span id="cb31-120"><a href="cuda-adv.html#cb31-120"></a>                printf(<span class="st">&quot;Texel at position (%- 5.3f, %- 5.3f, %- 5.3f)&quot;</span></span>
<span id="cb31-121"><a href="cuda-adv.html#cb31-121"></a>                       <span class="st">&quot; is (%- 5.3f, %- 5.3f) </span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb31-122"><a href="cuda-adv.html#cb31-122"></a>                        position[id].x, position[id].y, position[id].z,</span>
<span id="cb31-123"><a href="cuda-adv.html#cb31-123"></a>                        result[id].x, result[id].y);</span>
<span id="cb31-124"><a href="cuda-adv.html#cb31-124"></a>            }</span>
<span id="cb31-125"><a href="cuda-adv.html#cb31-125"></a>        }</span>
<span id="cb31-126"><a href="cuda-adv.html#cb31-126"></a>    }</span>
<span id="cb31-127"><a href="cuda-adv.html#cb31-127"></a>    cudaFree(curesult);</span>
<span id="cb31-128"><a href="cuda-adv.html#cb31-128"></a>    cudaFree(cuposition);</span>
<span id="cb31-129"><a href="cuda-adv.html#cb31-129"></a>    free(result);</span>
<span id="cb31-130"><a href="cuda-adv.html#cb31-130"></a>    free(position);</span>
<span id="cb31-131"><a href="cuda-adv.html#cb31-131"></a>    free(resource);</span>
<span id="cb31-132"><a href="cuda-adv.html#cb31-132"></a>    cudaDestroyTextureObject(tex3DObj);</span>
<span id="cb31-133"><a href="cuda-adv.html#cb31-133"></a>    cudaFreeArray(cuArray);</span>
<span id="cb31-134"><a href="cuda-adv.html#cb31-134"></a>    </span>
<span id="cb31-135"><a href="cuda-adv.html#cb31-135"></a>}</span></code></pre></div>
<p>å¯ä»¥å°è¯•å–ä¸åŒçš„ä½ç½®çœ‹çœ‹æ‹¾å–åˆ°çš„å€¼æ˜¯ä»€ä¹ˆã€‚</p>
</div>
</div>
<div id="å¦‚ä½•å®ç°åŒç²¾åº¦çº¹ç†" class="section level3">
<h3><span class="header-section-number">6.1.4</span> å¦‚ä½•å®ç°åŒç²¾åº¦çº¹ç†</h3>
<p>CUDAä¸æ”¯æŒåŒç²¾åº¦çº¹ç†ï¼Œä½†æ˜¯å¯ä»¥ç”¨ä¸€ä¸ªint2å–å»â€œéª—â€CUDAã€‚<br />
ç”¨<code>cudaCreateChannelDesc&lt;int2&gt;()</code>ç”Ÿæˆint2çš„æè¿°ã€‚<br />
å–åˆ°çº¹ç†ä»¥åå¯ä»¥ç”¨<code>__hiloint2double</code>å°†ä¸¤ä¸ªintè½¬åŒ–ä¸ºdoubleã€‚<br />
ä½†æ˜¯æ³¨æ„ï¼Œè¿™é‡Œå¿…é¡»å¾—å°†filterModeè®¾ç½®ä¸º<code>cudaFilterModePoint</code>ï¼Œå› ä¸ºå¯¹ä¸¤ä¸ªuintæ’å€¼å†ç»„åˆæˆdoubleè‚¯å®šå’Œå¯¹doubleæ’å€¼å¾—åˆ°çš„ç»“æœä¸åŒã€‚ï¼ˆè¯¦ç»†åŸç†å¯ä»¥å‚è€ƒé™„å½•ä¸­çš„æµ®ç‚¹æ•°çš„è®¡ç®—æœºè¡¨ç¤ºæ–¹æ³•ï¼‰ã€‚</p>
<blockquote>
<p>å‡è®¾ç”¨<code>int2 texel = tex3D&lt;int2&gt;(texture, position);</code>æ‹¾å–äº†texel<br />
è¦ç”Ÿæˆdoubleéœ€è¦<code>__hiloint2double(texel.y, texel.x)</code><br />
è¿™é‡Œå…ˆç”¨yåç”¨xä¼¼ä¹æœ‰ç‚¹åç›´è§‰ï¼Œä½†è¿™å…¶å®æ˜¯å› ä¸ºå¤„ç†å™¨æ˜¯å°ç«¯åºçš„ï¼Œå› æ­¤è¦å…ˆå†™y</p>
</blockquote>
</div>
<div id="æ‰€ä»¥ä¸ºä»€ä¹ˆè¦ç”¨çº¹ç†" class="section level3">
<h3><span class="header-section-number">6.1.5</span> æ‰€ä»¥ä¸ºä»€ä¹ˆè¦ç”¨çº¹ç†ï¼Ÿ</h3>
<p>ä¸Šé¢æåˆ°äº†ä½¿ç”¨çº¹ç†çš„è¯¸å¤šé™åˆ¶ï¼Œè€Œä¸”è¿˜å¾ˆéº»çƒ¦ã€‚<br />
æ¯”å¦‚è¦ä½¿ç”¨doubleçš„è¯ä¸èƒ½æ’å€¼ï¼Œè¿˜è¦é¢å¤–è¿›è¡Œè½¬æ¢ã€‚å³ä¾¿æ˜¯å¯ä»¥æ’å€¼çš„floatï¼Œæ’å€¼ç²¾åº¦ä¹Ÿä¸å¦‚æ‰‹åŠ¨æ’å€¼ï¼Œé‚£æ˜¯ä¸æ˜¯è¿™äº›æƒ…å†µä¸‹ä½¿ç”¨çº¹ç†æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ<br />
è¿™æ¶‰åŠåˆ°ç¼“å­˜çš„åŸç†ã€‚ç®€å•æ¥è®²ï¼Œæ¯æ¬¡è®¿é—®å†…å­˜ï¼Œå¦‚æœè¦è®¿é—®çš„å†…å®¹æ²¡æœ‰è¢«ç¼“å­˜ï¼Œé‚£ä¹ˆç¼“å­˜ä¼šæŠŠè¦è®¿é—®çš„å†…å­˜å’Œå…¶é™„è¿‘çš„å†…å­˜ç¼“å­˜èµ·æ¥ï¼Œä¸‹æ¬¡å¦‚æœè®¿é—®ç›¸é‚»çš„å†…å­˜å¯ä»¥ç›´æ¥ä»ç¼“å­˜è·å–æ•°æ®ï¼Œå‡å°‘è®¿é—®å†…å­˜çš„å¼€é”€ã€‚è€Œä¸€èˆ¬çš„ç¼“å­˜è®¾è®¡è®¤ä¸ºå†…å­˜æ˜¯çº¿æ€§çš„ï¼Œä½†æ˜¯åœ¨äºŒç»´æˆ–è€…ä¸‰ç»´æƒ…å†µä¸‹ï¼Œæ¯æ¬¡è®¿é—®å†…å­˜åï¼Œæ¥ç€è®¿é—®çš„å¾ˆå¯èƒ½æ˜¯é€»è¾‘ä¸Šåœ¨ç©ºé—´ä¸­ç›¸é‚»çš„å†…å­˜ï¼Œè¿™æ ·å°±æ— æ³•åˆ©ç”¨ç¼“å­˜è¿›è¡Œé«˜é€Ÿè¯»å†™ã€‚GPUä¸­æœ‰ä¸“é—¨çš„çº¹ç†ç¼“å­˜ï¼Œå…·æœ‰ç©ºé—´å±€éƒ¨æ€§ï¼Œä¼šç¼“å­˜åœ¨é€»è¾‘ç©ºé—´ä¸­ä¸´è¿‘çš„å†…å®¹ï¼Œè€Œä¸å†æ˜¯çº¿æ€§å†…å­˜çš„â€œé™„è¿‘â€ã€‚</p>
<blockquote>
<p>CUDAçš„æ–‡æ¡£ä¸­æåˆ°çº¹ç†ç¼“å­˜å…·æœ‰äºŒç»´çš„ç©ºé—´å±€éƒ¨æ€§ï¼Œä½†æ˜¯æ²¡æœ‰æåˆ°ä¸‰ç»´çš„æƒ…å†µã€‚å› æ­¤ä¸èƒ½ç¡®å®šç¼“å­˜åœ¨ä¸‰ç»´çº¹ç†çš„æƒ…å†µä¸‹æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ä½†å³ä¾¿æ˜¯äºŒç»´çš„å±€éƒ¨æ€§ï¼Œä¹Ÿä¼šæ¯”æ™®é€šçš„ä¸€ç»´ç¼“å­˜å‘½ä¸­ç‡é«˜ä¸€äº›ã€‚</p>
</blockquote>
</div>
</div>
<div id="æµ" class="section level2">
<h2><span class="header-section-number">6.2</span> æµ</h2>
<blockquote>
<p><em>å‚å·®è‡èœï¼Œå·¦å³æµä¹‹ã€‚çªˆçª•æ·‘å¥³ï¼Œå¯¤å¯æ±‚ä¹‹ã€‚â€”â€”ã€Šè¯—ç»ã€‹</em></p>
</blockquote>
<p>ä¹‹å‰çš„ç¨‹åºï¼Œæˆ‘ä»¬éƒ½æ˜¯CPUå®‰ç½®å¥½æ•°æ®ä»¥åæŠŠä»»åŠ¡å®‰æ’ç»™GPUï¼Œç„¶åå°±å¼€å§‹ç­‰ï¼Œç­‰åˆ°GPUè¿è¡Œå®Œç¨‹åºä»¥åæŠŠæ•°æ®æ‹¿å›æ¥ã€‚ä½†æ˜¯æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥æŠŠCPUä¹Ÿåˆ©ç”¨èµ·æ¥å¹²ç‚¹åˆ«çš„ï¼Ÿå¯ä»¥çš„ï¼</p>
<p>è¿™é‡Œè¦å¼•å…¥ä¸€ä¸ªæµçš„æ¦‚å¿µã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæµï¼Œç„¶åæŠŠéœ€è¦åšçš„äº‹æƒ…æ”¾è¿›æµé‡Œé¢ï¼Œä¸€ä¸ªæµé‡Œæœ‰ä»»åŠ¡çš„è¯å°±ä¼šè‡ªåŠ¨å¼€å§‹å·¥ä½œã€‚è¿™æ—¶ä¸»æœºçš„å·¥ä½œåªæ˜¯æŠŠä»»åŠ¡æ¨åˆ°æµé‡Œé¢ï¼Œç„¶åå°±å¯ä»¥åšåˆ«çš„å·¥ä½œäº†ã€‚æœ€åå†è®©æµå’Œè‡ªå·±åŒæ­¥ä¸€ä¸‹ï¼Œä¿è¯æµé‡Œçš„å·¥ä½œåšå®Œäº†å³å¯ã€‚</p>
<p>äº‹å®ä¸Šï¼Œå½“ä¸åˆ›å»ºæ–°çš„æµçš„æ—¶å€™ï¼Œæ˜¯ä½¿ç”¨é»˜è®¤æµæ¥å·¥ä½œçš„ï¼Œè¿™ä¸ªæµæ˜¯â€œé˜»å¡â€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæµé‡Œçš„ä»»åŠ¡å®Œæˆä¹‹å‰ä¼šé˜²æ­¢CPUè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚è€Œæˆ‘ä»¬å¦å¤–åˆ›å»ºçš„æµæ˜¯â€œéé˜»å¡â€çš„ï¼Œä¸ä¼šå¯¹CPUçš„å·¥ä½œæµç¨‹é€ æˆå½±å“ã€‚</p>
<div id="ä¸¾ä¸ªä¾‹å­" class="section level3">
<h3><span class="header-section-number">6.2.1</span> ä¸¾ä¸ªä¾‹å­</h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb32-1"><a href="cuda-adv.html#cb32-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb32-2"><a href="cuda-adv.html#cb32-2"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb32-3"><a href="cuda-adv.html#cb32-3"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb32-4"><a href="cuda-adv.html#cb32-4"></a><span class="pp">#include </span><span class="im">&lt;cuda_runtime.h&gt;</span></span>
<span id="cb32-5"><a href="cuda-adv.html#cb32-5"></a></span>
<span id="cb32-6"><a href="cuda-adv.html#cb32-6"></a>__global__ <span class="dt">void</span> muladd(<span class="dt">double</span>* a, <span class="dt">double</span>* b, <span class="dt">double</span>* c, <span class="dt">double</span>* d,</span>
<span id="cb32-7"><a href="cuda-adv.html#cb32-7"></a>                       <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> N){</span>
<span id="cb32-8"><a href="cuda-adv.html#cb32-8"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> id = blockIdx.x * blockDim.x + threadIdx.x;</span>
<span id="cb32-9"><a href="cuda-adv.html#cb32-9"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> j;</span>
<span id="cb32-10"><a href="cuda-adv.html#cb32-10"></a>    <span class="cf">if</span>(id &lt; N){</span>
<span id="cb32-11"><a href="cuda-adv.html#cb32-11"></a>        <span class="cf">for</span>(j = <span class="dv">0</span>; j &lt; <span class="dv">1000000</span>; j++){</span>
<span id="cb32-12"><a href="cuda-adv.html#cb32-12"></a>            d[id] = a[id] * b[id] + c[id];</span>
<span id="cb32-13"><a href="cuda-adv.html#cb32-13"></a>        }</span>
<span id="cb32-14"><a href="cuda-adv.html#cb32-14"></a>    }</span>
<span id="cb32-15"><a href="cuda-adv.html#cb32-15"></a>}</span>
<span id="cb32-16"><a href="cuda-adv.html#cb32-16"></a></span>
<span id="cb32-17"><a href="cuda-adv.html#cb32-17"></a><span class="dt">int</span> main(){</span>
<span id="cb32-18"><a href="cuda-adv.html#cb32-18"></a>    <span class="dt">double</span>* a; </span>
<span id="cb32-19"><a href="cuda-adv.html#cb32-19"></a>    <span class="dt">double</span>* b; </span>
<span id="cb32-20"><a href="cuda-adv.html#cb32-20"></a>    <span class="dt">double</span>* c; </span>
<span id="cb32-21"><a href="cuda-adv.html#cb32-21"></a>    <span class="dt">double</span>* d;</span>
<span id="cb32-22"><a href="cuda-adv.html#cb32-22"></a></span>
<span id="cb32-23"><a href="cuda-adv.html#cb32-23"></a>    <span class="dt">double</span>** cua;</span>
<span id="cb32-24"><a href="cuda-adv.html#cb32-24"></a>    <span class="dt">double</span>** cub;</span>
<span id="cb32-25"><a href="cuda-adv.html#cb32-25"></a>    <span class="dt">double</span>** cuc;</span>
<span id="cb32-26"><a href="cuda-adv.html#cb32-26"></a>    <span class="dt">double</span>** cud;</span>
<span id="cb32-27"><a href="cuda-adv.html#cb32-27"></a></span>
<span id="cb32-28"><a href="cuda-adv.html#cb32-28"></a>    cudaMallocHost(&amp;a, <span class="dv">8192</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>));</span>
<span id="cb32-29"><a href="cuda-adv.html#cb32-29"></a>    cudaMallocHost(&amp;b, <span class="dv">8192</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>));</span>
<span id="cb32-30"><a href="cuda-adv.html#cb32-30"></a>    cudaMallocHost(&amp;c, <span class="dv">8192</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>));</span>
<span id="cb32-31"><a href="cuda-adv.html#cb32-31"></a>    cudaMallocHost(&amp;d, <span class="dv">8192</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>));</span>
<span id="cb32-32"><a href="cuda-adv.html#cb32-32"></a></span>
<span id="cb32-33"><a href="cuda-adv.html#cb32-33"></a>    cua = (<span class="dt">double</span>**)(malloc(<span class="dv">2</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>*)));</span>
<span id="cb32-34"><a href="cuda-adv.html#cb32-34"></a>    cub = (<span class="dt">double</span>**)(malloc(<span class="dv">2</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>*)));</span>
<span id="cb32-35"><a href="cuda-adv.html#cb32-35"></a>    cuc = (<span class="dt">double</span>**)(malloc(<span class="dv">2</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>*)));</span>
<span id="cb32-36"><a href="cuda-adv.html#cb32-36"></a>    cud = (<span class="dt">double</span>**)(malloc(<span class="dv">2</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>*)));</span>
<span id="cb32-37"><a href="cuda-adv.html#cb32-37"></a></span>
<span id="cb32-38"><a href="cuda-adv.html#cb32-38"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> i;</span>
<span id="cb32-39"><a href="cuda-adv.html#cb32-39"></a>    <span class="cf">for</span>(i = <span class="dv">0</span>; i &lt; <span class="dv">8192</span>; i++){</span>
<span id="cb32-40"><a href="cuda-adv.html#cb32-40"></a>        a[i] = (<span class="dt">double</span>)(rand()%<span class="dv">2000</span>) / <span class="fl">200.0</span>;</span>
<span id="cb32-41"><a href="cuda-adv.html#cb32-41"></a>        b[i] = (<span class="dt">double</span>)(rand()%<span class="dv">2000</span>) / <span class="fl">200.0</span>;</span>
<span id="cb32-42"><a href="cuda-adv.html#cb32-42"></a>        c[i] = ((<span class="dt">double</span>)i)/<span class="fl">10000.0</span>;</span>
<span id="cb32-43"><a href="cuda-adv.html#cb32-43"></a>    }</span>
<span id="cb32-44"><a href="cuda-adv.html#cb32-44"></a>    </span>
<span id="cb32-45"><a href="cuda-adv.html#cb32-45"></a>    <span class="co">//å£°æ˜æµ</span></span>
<span id="cb32-46"><a href="cuda-adv.html#cb32-46"></a>    cudaStream_t streams[<span class="dv">2</span>];</span>
<span id="cb32-47"><a href="cuda-adv.html#cb32-47"></a>    <span class="co">//åˆ›å»ºæµï¼Œå¹¶åˆ†é…ä¸€äº›æ˜¾å­˜ç©ºé—´ã€‚</span></span>
<span id="cb32-48"><a href="cuda-adv.html#cb32-48"></a>    <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">2</span>; i++){</span>
<span id="cb32-49"><a href="cuda-adv.html#cb32-49"></a>        cudaStreamCreate(&amp;streams[i]);</span>
<span id="cb32-50"><a href="cuda-adv.html#cb32-50"></a>        cudaMalloc(&amp;(cua[i]),<span class="dv">1024</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>));</span>
<span id="cb32-51"><a href="cuda-adv.html#cb32-51"></a>        cudaMalloc(&amp;(cub[i]),<span class="dv">1024</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>));</span>
<span id="cb32-52"><a href="cuda-adv.html#cb32-52"></a>        cudaMalloc(&amp;(cuc[i]),<span class="dv">1024</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>));</span>
<span id="cb32-53"><a href="cuda-adv.html#cb32-53"></a>        cudaMalloc(&amp;(cud[i]),<span class="dv">1024</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>));</span>
<span id="cb32-54"><a href="cuda-adv.html#cb32-54"></a>    }</span>
<span id="cb32-55"><a href="cuda-adv.html#cb32-55"></a></span>
<span id="cb32-56"><a href="cuda-adv.html#cb32-56"></a>    <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">8</span>; i++){</span>
<span id="cb32-57"><a href="cuda-adv.html#cb32-57"></a>        cudaMemcpyAsync(cua[i%<span class="dv">2</span>], a+i*<span class="dv">1024</span>, <span class="dv">1024</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>),</span>
<span id="cb32-58"><a href="cuda-adv.html#cb32-58"></a>                        cudaMemcpyHostToDevice, streams[i%<span class="dv">2</span>]);</span>
<span id="cb32-59"><a href="cuda-adv.html#cb32-59"></a></span>
<span id="cb32-60"><a href="cuda-adv.html#cb32-60"></a>        cudaMemcpyAsync(cub[i%<span class="dv">2</span>], b+i*<span class="dv">1024</span>, <span class="dv">1024</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>),</span>
<span id="cb32-61"><a href="cuda-adv.html#cb32-61"></a>                        cudaMemcpyHostToDevice, streams[i%<span class="dv">2</span>]);</span>
<span id="cb32-62"><a href="cuda-adv.html#cb32-62"></a></span>
<span id="cb32-63"><a href="cuda-adv.html#cb32-63"></a>        cudaMemcpyAsync(cuc[i%<span class="dv">2</span>], c+i*<span class="dv">1024</span>, <span class="dv">1024</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>),</span>
<span id="cb32-64"><a href="cuda-adv.html#cb32-64"></a>                        cudaMemcpyHostToDevice, streams[i%<span class="dv">2</span>]);</span>
<span id="cb32-65"><a href="cuda-adv.html#cb32-65"></a></span>
<span id="cb32-66"><a href="cuda-adv.html#cb32-66"></a>        muladd&lt;&lt;&lt;<span class="dv">16</span>, <span class="dv">256</span>, <span class="dv">0</span>, streams[i%<span class="dv">2</span>]&gt;&gt;&gt;(cua[i%<span class="dv">2</span>], cub[i%<span class="dv">2</span>],</span>
<span id="cb32-67"><a href="cuda-adv.html#cb32-67"></a>                                             cuc[i%<span class="dv">2</span>], cud[i%<span class="dv">2</span>], <span class="dv">1024</span>);</span>
<span id="cb32-68"><a href="cuda-adv.html#cb32-68"></a></span>
<span id="cb32-69"><a href="cuda-adv.html#cb32-69"></a>        cudaMemcpyAsync(d+i*<span class="dv">1024</span>, cud[i%<span class="dv">2</span>], <span class="dv">1024</span>*<span class="kw">sizeof</span>(<span class="dt">double</span>),</span>
<span id="cb32-70"><a href="cuda-adv.html#cb32-70"></a>                        cudaMemcpyDeviceToHost, streams[i%<span class="dv">2</span>]);</span>
<span id="cb32-71"><a href="cuda-adv.html#cb32-71"></a>    }</span>
<span id="cb32-72"><a href="cuda-adv.html#cb32-72"></a>    <span class="co">//CPUç°åœ¨å¯ä»¥å¹²ç‚¹åˆ«çš„</span></span>
<span id="cb32-73"><a href="cuda-adv.html#cb32-73"></a>    <span class="co">//......</span></span>
<span id="cb32-74"><a href="cuda-adv.html#cb32-74"></a>    <span class="co">//æå®Œä»¥å</span></span>
<span id="cb32-75"><a href="cuda-adv.html#cb32-75"></a>    <span class="co">//å’Œæ˜¾å¡åŒæ­¥ä¸€ä¸‹ï¼Œä¿è¯æ˜¾å¡ä¸Šçš„æ¯ä¸ªæµéƒ½æ‰§è¡Œå®Œäº†é‡Œé¢çš„ä»»åŠ¡</span></span>
<span id="cb32-76"><a href="cuda-adv.html#cb32-76"></a>    cudaDeviceSynchronize();</span>
<span id="cb32-77"><a href="cuda-adv.html#cb32-77"></a></span>
<span id="cb32-78"><a href="cuda-adv.html#cb32-78"></a>    <span class="cf">for</span>(i = <span class="dv">0</span>; i &lt; <span class="dv">8192</span>; i++){</span>
<span id="cb32-79"><a href="cuda-adv.html#cb32-79"></a>        <span class="cf">if</span>(i % <span class="dv">1001</span> == <span class="dv">0</span>){</span>
<span id="cb32-80"><a href="cuda-adv.html#cb32-80"></a>            printf(<span class="st">&quot;%5llu: %16.8f * %16.8f + %16.8f = %16.8f (%d)</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb32-81"><a href="cuda-adv.html#cb32-81"></a>                    i, a[i], b[i], c[i], d[i], d[i]==a[i]*b[i]+c[i]);</span>
<span id="cb32-82"><a href="cuda-adv.html#cb32-82"></a>        }</span>
<span id="cb32-83"><a href="cuda-adv.html#cb32-83"></a>    }</span>
<span id="cb32-84"><a href="cuda-adv.html#cb32-84"></a></span>
<span id="cb32-85"><a href="cuda-adv.html#cb32-85"></a>    <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">2</span>; i++){</span>
<span id="cb32-86"><a href="cuda-adv.html#cb32-86"></a>        cudaFree(cua[i]);</span>
<span id="cb32-87"><a href="cuda-adv.html#cb32-87"></a>        cudaFree(cub[i]);</span>
<span id="cb32-88"><a href="cuda-adv.html#cb32-88"></a>        cudaFree(cuc[i]);</span>
<span id="cb32-89"><a href="cuda-adv.html#cb32-89"></a>        cudaFree(cud[i]);</span>
<span id="cb32-90"><a href="cuda-adv.html#cb32-90"></a>        <span class="co">//ç”¨å®Œçš„æµè¦é”€æ¯æ‰</span></span>
<span id="cb32-91"><a href="cuda-adv.html#cb32-91"></a>        cudaStreamDestroy(streams[i]);</span>
<span id="cb32-92"><a href="cuda-adv.html#cb32-92"></a>    }</span>
<span id="cb32-93"><a href="cuda-adv.html#cb32-93"></a>    <span class="co">//cudaFreeHost å’Œ cudaMallocHostç›¸å¯¹åº”</span></span>
<span id="cb32-94"><a href="cuda-adv.html#cb32-94"></a></span>
<span id="cb32-95"><a href="cuda-adv.html#cb32-95"></a>    free(cua);</span>
<span id="cb32-96"><a href="cuda-adv.html#cb32-96"></a>    free(cub);</span>
<span id="cb32-97"><a href="cuda-adv.html#cb32-97"></a>    free(cuc);</span>
<span id="cb32-98"><a href="cuda-adv.html#cb32-98"></a>    free(cud);</span>
<span id="cb32-99"><a href="cuda-adv.html#cb32-99"></a></span>
<span id="cb32-100"><a href="cuda-adv.html#cb32-100"></a>    cudaFreeHost(a);</span>
<span id="cb32-101"><a href="cuda-adv.html#cb32-101"></a>    cudaFreeHost(b);</span>
<span id="cb32-102"><a href="cuda-adv.html#cb32-102"></a>    cudaFreeHost(c);</span>
<span id="cb32-103"><a href="cuda-adv.html#cb32-103"></a>    cudaFreeHost(d);</span>
<span id="cb32-104"><a href="cuda-adv.html#cb32-104"></a>}</span></code></pre></div>
<p>ä¸Šé¢çš„ç¨‹åºåˆ›å»ºäº†ä¸¤ä¸ªæµã€‚ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œæ¯ä¸ªæµä½¿ç”¨çš„æ˜¾å­˜ç©ºé—´ä¹Ÿæ˜¯åˆ†å¼€ç”³è¯·çš„ã€‚</p>
<p>æ³¨æ„åˆ°ç¨‹åºé‡Œé¢åˆ†é…ä¸»æœºå†…å­˜ç©ºé—´çš„æ—¶å€™æ²¡æœ‰ä½¿ç”¨<code>malloc</code>è€Œæ˜¯ä½¿ç”¨äº†<code>cudaMallocHost</code>ã€‚è¿™æ˜¯å› ä¸ºéåŒæ­¥æ‹·è´éœ€è¦è¢«æ‹·è´çš„ä¸»æœºå†…å®¹æ˜¯â€œé¡µé”å®šâ€çš„å†…å­˜ï¼Œè€Œç›´æ¥ç”¨<code>malloc</code>ç”³è¯·çš„ç©ºé—´ä¸å…·å¤‡è¿™ç§æ€§è´¨ã€‚</p>
<blockquote>
<p>å†…å­˜æ˜¯åˆ†é¡µçš„ï¼Œå…·ä½“è®²èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œå¤§è‡´æ¥è¯´å°±æ˜¯ç¨‹åºä¸­ä½¿ç”¨çš„åœ°å€æ˜¯è™šæ‹Ÿçš„ï¼Œç„¶ååœ¨ç»è¿‡ä¸€ä¸ªè™šæ‹Ÿåœ°å€åˆ°çœŸå®åœ°å€çš„æ˜ å°„æ¥è®¿é—®çœŸå®å†…å­˜ä½ç½®ã€‚è€ŒçœŸå®ä½ç½®ç”šè‡³å¯èƒ½æ˜¯ä¸è¿ç»­çš„ã€‚è€Œæ‰€è°“â€œé¡µé”å®šâ€å†…å­˜æ˜¯çœŸå®å†…å­˜åœ°å€ï¼Œä¸åˆ†é¡µçš„ã€‚è¿™æ ·GPUä»å†…å­˜è¯»å–æ•°æ®å°±ä¸éœ€è¦é€šè¿‡CPUæŸ¥è¯¢é¡µè¡¨ï¼Œå¯ä»¥ç›´æ¥ä»å†…å­˜å–æ•°æ®äº†ã€‚ä½¿ç”¨<code>cudaMallocHost</code>ä¸ä»…ä½¿å¾—ä½¿ç”¨æµæˆä¸ºå¯èƒ½ï¼Œè¿˜å¯ä»¥æé«˜æ•°æ®ä¼ è¾“æ•ˆç‡ã€‚<br />
ä½†æ˜¯è¦æ³¨æ„ï¼Œä¸åˆ†é¡µæ„å‘³ç€å³ä½¿å†…å­˜å ç”¨è¿‡é«˜çš„æ—¶å€™æ“ä½œç³»ç»Ÿä¹Ÿä¸èƒ½å°†è¿™éƒ¨åˆ†å†…å­˜æ”¾å…¥äº¤æ¢ç©ºé—´ã€‚å› æ­¤ç”³è¯·çš„é¡µé”å®šå†…å­˜è¿‡å¤§å¯èƒ½ä¼šå½±å“å…¶ä»–ç”¨æˆ·çš„ä½“éªŒã€‚è¿™äº›å†…å­˜ä½¿ç”¨å®Œåä¹Ÿè¯·åŠæ—¶é‡Šæ”¾ã€‚</p>
</blockquote>
<p>åé¢çš„<code>cudaMemcpyAsync</code>å’Œ<code>cudaMemcpy</code>æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡è¦åœ¨æœ€åä¸€ä¸ªå‚æ•°é‡ŒæŒ‡å®šè¿™ä¸ªæ“ä½œè¦è¢«å®‰æ’åœ¨å“ªä¸€ä¸ªæµé‡Œé¢ã€‚</p>
<p>è°ƒç”¨kernelçš„æ—¶å€™ï¼Œ<code>&lt;&lt;&lt;...&gt;&gt;&gt;</code>é‡Œé¢çš„å‚æ•°å˜æˆäº†4ä¸ªã€‚å‰ä¸¤ä¸ªè¿˜ä¸å˜ï¼Œç¬¬ä¸‰ä¸ªè¡¨ç¤ºè¦åŠ¨æ€ç”³è¯·çš„å…±äº«å†…å­˜çš„å¤§å°ï¼Œç”±äºè¿™é‡Œä¸éœ€è¦å…±äº«å†…å­˜ï¼Œå¡«0å³å¯ã€‚ç¬¬å››ä¸ªå‚æ•°æ˜¯è¦ä½¿ç”¨çš„æµã€‚</p>
<blockquote>
<p>å…±äº«å†…å­˜æ˜¯ä¸€ç§â€œç‰‡ä¸Šå†…å­˜â€ï¼Œå’Œæ˜¾å­˜ç©ºé—´æ˜¯ç‹¬ç«‹çš„ã€‚å…±äº«å†…å­˜ç©ºé—´æ¯”è¾ƒå°ï¼Œä½†æ˜¯é€Ÿåº¦æ¯”æ˜¾å­˜å¿«ã€‚å…±äº«å†…å­˜æ˜¯åˆ†é…ç»™blockçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªblockèƒ½çœ‹åˆ°è‡ªå·±çš„å…±äº«å†…å­˜ï¼Œä½†æ˜¯äº’ç›¸æ˜¯çœ‹ä¸åˆ°çš„ã€‚ä¸€ä¸ªblockä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥çœ‹åˆ°è¿™ä¸ªblockçš„å…±äº«å†…å­˜ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ã€‚æ¯ä¸€ä¸ªå—èƒ½æ‹¥æœ‰çš„å…±äº«å†…å­˜å¤§å°å¯ä»¥æŸ¥è¯¢ï¼ˆå‚è€ƒCUDA sampleé‡Œçš„1_Utilities/deviceQueryï¼‰ã€‚</p>
</blockquote>
<p>åé¢çš„<code>cudaDeviceSynchronize();</code>å¯ä»¥åŒæ­¥ä¸€å—æ˜¾å¡ä¸Šçš„æ‰€æœ‰æµã€‚å®ƒä¼šç­‰å¾…ç›´åˆ°æ‰€æœ‰æµé‡Œçš„æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆåæ‰è¿”å›ï¼Œç›¸å½“äºè®©CPUç­‰å¾…GPUå®Œæˆå·¥ä½œã€‚å¦‚æœæƒ³è¦åªåŒæ­¥ä¸€ä¸ªæµï¼Œå¯ä»¥ç”¨<code>cudaStreamSynchronize</code>å‡½æ•°ï¼Œä¼ å…¥ä¸€ä¸ª<code>stream_t</code>å˜é‡å³å¯åŒæ­¥å¯¹åº”çš„æµã€‚</p>
<p>ä¸€ä¸ªæµé‡Œçš„ä»»åŠ¡æ˜¯æŒ‰ç…§æ¨å…¥ä»»åŠ¡é¡ºåºå®Œæˆçš„ï¼Œæµä¹‹é—´å¦‚æœä¸è¿›è¡ŒåŒæ­¥æ˜¯ä¸ä¿è¯æ‰§è¡Œé¡ºåºçš„ã€‚</p>
</div>
<div id="å›è°ƒ" class="section level3">
<h3><span class="header-section-number">6.2.2</span> å›è°ƒ</h3>
<p>é™¤äº†å¯ä»¥å‘æµé‡Œæ·»åŠ å†…å­˜æ‹·è´ä»»åŠ¡å’Œæ‰§è¡Œkernelä»»åŠ¡ï¼Œè¿˜å¯ä»¥æ·»åŠ å›è°ƒä»»åŠ¡ã€‚</p>
<p>å›è°ƒä»»åŠ¡ç›¸å½“äºä¸€ä¸ªè¿è¡Œåœ¨CPUä¸Šçš„å‡½æ•°ï¼Œå½“å›è°ƒä»»åŠ¡å‰é¢çš„ä»»åŠ¡éƒ½ç»“æŸåï¼Œä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å®šä¹‰ä¸€ä¸ªå›è°ƒå‡½æ•°</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb33-1"><a href="cuda-adv.html#cb33-1"></a></span>
<span id="cb33-2"><a href="cuda-adv.html#cb33-2"></a><span class="dt">void</span> CUDART_CB my_callback(cudaStream_t stream,</span>
<span id="cb33-3"><a href="cuda-adv.html#cb33-3"></a>                           cudaError_t status, <span class="dt">void</span>* data) {</span>
<span id="cb33-4"><a href="cuda-adv.html#cb33-4"></a>    <span class="dt">char</span>* message = (<span class="dt">char</span>*)(data);</span>
<span id="cb33-5"><a href="cuda-adv.html#cb33-5"></a>    printf(<span class="st">&quot;Callback!</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb33-6"><a href="cuda-adv.html#cb33-6"></a>    printf(<span class="st">&quot;Message: %s</span><span class="sc">\n</span><span class="st">&quot;</span>, message);</span>
<span id="cb33-7"><a href="cuda-adv.html#cb33-7"></a>}</span></code></pre></div>
<p>å…¶ä¸­çš„dataæ˜¯<code>void</code>å‹çš„æŒ‡é’ˆï¼Œå¯ä»¥ç”¨æ¥å‘å›è°ƒå‡½æ•°ä¼ é€’ä¿¡æ¯ã€‚è¿™é‡Œæˆ‘ä»¬éšä¾¿ä¼ é€’ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å°†ä¸Šé¢çš„å›è°ƒå‡½æ•°æ·»åŠ åˆ°ä¸€ä¸ªå«åš<code>stream1</code>çš„æµ</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb34-1"><a href="cuda-adv.html#cb34-1"></a><span class="dt">char</span>* msg = <span class="st">&quot;Encountering a callback!&quot;</span>;</span>
<span id="cb34-2"><a href="cuda-adv.html#cb34-2"></a>cudaStreamAddCallback(stream1, my_callback, (<span class="dt">void</span>*)msg, <span class="dv">0</span>);</span></code></pre></div>
<p>å…¶ä¸­ç¬¬å››ä¸ªå‚æ•°æ˜¯ä¸ºæœªæ¥çš„åŠŸèƒ½é¢„ç•™çš„ï¼Œç°åœ¨å¿…é¡»è®¾ä¸º0.</p>
<p>ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯å³å°†å˜æˆä¸Šé¢å®šä¹‰å›è°ƒå‡½æ•°æ—¶è®¾å®šçš„<code>void* data</code>çš„å†…å®¹ã€‚</p>
</div>
<div id="ä»€ä¹ˆæ—¶å€™è¦ä½¿ç”¨æµ" class="section level3">
<h3><span class="header-section-number">6.2.3</span> ä»€ä¹ˆæ—¶å€™è¦ä½¿ç”¨æµ</h3>
<p>å½“æ•°æ®æ‹·è´å’Œæ•°æ®å¤„ç†ç”¨æ—¶å·®ä¸å¤šçš„æ—¶å€™ä½¿ç”¨æµå¯ä»¥æé«˜é€Ÿåº¦ã€‚è¿™æ˜¯å› ä¸ºè¿›è¡Œè®¡ç®—çš„æ—¶å€™å†…å­˜å’Œæ˜¾å¡ä¹‹é—´çš„å¸¦å®½æ—¶é—²ç½®çš„ã€‚ä½¿ç”¨å¤šä¸ªæµå¯ä»¥åœ¨è®¡ç®—ä¸€éƒ¨åˆ†æ•°æ®çš„æ—¶å€™æ‹·è´å…¶ä»–æ•°æ®ã€‚</p>
<p>åŒæ—¶ï¼Œç”±äºPCIeæ€»çº¿æ˜¯å…¨åŒå·¥çš„ï¼Œä¸»æœºåˆ°è®¾å¤‡çš„æ‹·è´å’Œè®¾å¤‡åˆ°ä¸»æœºçš„æ‹·è´ä¹Ÿæ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ã€‚</p>
<p>å¦‚æœæ‹·è´ä¸ŠèŠ±çš„æ—¶é—´æ¯”è®¡ç®—æ—¶é—´é•¿ï¼Œä¹Ÿè®¸è¦è€ƒè™‘åŒ…å«æ‹·è´æ—¶é—´çš„è¯è¿™ç§è®¡ç®—æ˜¯ä¸æ˜¯çœŸçš„æ¯”CPUå¿«äº†ã€‚ï¼ˆå…¶å®æ‹·è´è¿˜è›®å¿«çš„ï¼‰</p>
<p>å¦‚æœæ˜¯è®¡ç®—å¯†é›†å‹çš„ï¼Œæ‹·è´æ—¶é—´å¯ä»¥å¿½ç•¥ä¸è®¡çš„è¯ä¸å»ºè®®ä½¿ç”¨éé»˜è®¤çš„æµï¼ˆé™¤éå¸Œæœ›åœ¨CPUä¸ŠåŒæ—¶è¿›è¡Œå…¶ä»–å·¥ä½œï¼‰ã€‚</p>
<p>æ­¤å¤–ï¼Œæ°¸è¿œä¸å»ºè®®å°†æ•°æ®åˆ†ä¸ºéå¸¸å¤šçš„å°å—ã€‚å› ä¸ºæ‹·è´æ•°æ®çš„å¸¦å®½è™½ç„¶å¾ˆå®½ï¼Œä½†æ˜¯æœ‰ä¸€å®šçš„å»¶è¿Ÿã€‚åˆ†å¤ªå¤šçš„å—çš„è¯å»¶è¿Ÿæ—¶é—´ç´¯ç§¯èµ·æ¥ä¹Ÿä¸å¯å°è§‘ã€‚</p>
</div>
</div>
<div id="ç¼“å­˜å’Œå…±äº«å†…å­˜çš„åˆ†é…" class="section level2">
<h2><span class="header-section-number">6.3</span> ç¼“å­˜å’Œå…±äº«å†…å­˜çš„åˆ†é…</h2>
<p><strong><em>è¿™ä¸€èŠ‚çš„å†…å®¹æˆ‘ä¹Ÿæ²¡æœ‰å°è¯•è¿‡ï¼Œä½†æ˜¯åŸåˆ™ä¸Šåº”è¯¥æ˜¯å¯è¡Œçš„ã€‚</em></strong></p>
<p>å…±äº«å†…å­˜æ˜¯ä¼¼ä¹æ˜¯ç›´æ¥æ”¾åœ¨é«˜é€Ÿç¼“å­˜ä¸­çš„ã€‚cudaå…è®¸è°ƒæ•´å…±äº«å†…å­˜å’ŒL1é«˜é€Ÿç¼“å­˜çš„æ¯”ä¾‹ã€‚</p>
<p>é€šè¿‡<code>cudaFuncSetCacheConfig</code>å‡½æ•°å¯ä»¥è°ƒæ•´ã€‚å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªkernelå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯<code>__global__</code>å‡½æ•°ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æ˜¯</p>
<ul>
<li>cudaFuncCachePreferNone ä½¿ç”¨é»˜è®¤å€¼</li>
<li>cudaFuncCachePreferShared æ›´å¤šçš„å…±äº«å†…å­˜</li>
<li>cudaFuncCachePreferL1 æ›´å¤šçš„L1é«˜é€Ÿç¼“å­˜</li>
<li>cudaFuncCachePreferEqual å¹³å‡åˆ†é…</li>
</ul>
</div>
<div id="cuadv_sum" class="section level2">
<h2><span class="header-section-number">6.4</span> æœ¬ç« å°ç»“</h2>
<p>è¿™ä¸€ç« å°±åˆ°è¿™é‡Œäº†ã€‚å…¶ä»–å†…å®¹æ¯”å¦‚å„ç§â€œå±€éƒ¨å†…å­˜â€ã€â€œå¸¸é‡å†…å­˜â€å’Œâ€œå…±äº«å†…å­˜â€ç­‰å†…å®¹ï¼Œè¿˜æœ‰å…¶ä»–å„ç§<del>å¥‡æŠ€æ·«å·§</del>æŠ€æœ¯æˆ‘ä¹Ÿæ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œè¿™é‡Œå°±ä¸è°ˆäº†ã€‚è¯¸å›æ„Ÿå…´è¶£å¯ä»¥è‡ªå·±æ‰¾èµ„æ–™çœ‹ä¸€çœ‹ã€‚</p>
<p><strong>åˆ°äº†è¿™ä¸€ç« ï¼Œå°æœ‹å‹å·²ç»é—®ä¸åŠ¨é—®é¢˜äº†ã€‚</strong></p>
<p>è¯¸å›æœ‰ç–‘é—®å†è®¨è®ºå§ã€‚æœ‰åˆé€‚çš„é—®é¢˜å¯ä»¥åœ¨åç»­ç‰ˆæœ¬ä¸­æ›´æ–°ä¸Šæ¥ã€‚</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="cuda.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="nsight.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/yihui/bookdown-chinese/edit/master/04-advanced.Rmd",
"text": "ç¼–è¾‘"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bookdown.pdf", "bookdown.epub"],
"toc": {
"collapse": "none"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>

# (PART) cè¯­è¨€å¹¶è¡Œç¼–ç¨‹ {-} 

# ç¬¬ä¸€éƒ¨åˆ† {#part1 .unnumbered}

ç¬¬ä¸€éƒ¨åˆ†å€Ÿcè¯­è¨€å¹¶è¡Œç¼–ç¨‹ä¹‹é¢˜ï¼Œè¡Œä»‹ç»é«˜çº§çŸ¢é‡æ‰©å±•å’Œçº¿ç¨‹ä¹‹å®ã€‚

ç¬¬ä¸€éƒ¨åˆ†çš„ç¨‹åºå¦‚æ— ç‰¹æ®Šè¯´æ˜ï¼Œéƒ½èƒ½åœ¨gcc7.3.0ä¸‹ç¼–è¯‘é€šè¿‡ï¼ˆå¦‚æœæˆ‘æ²¡æœ‰æŠ„é”™çš„è¯ï¼‰ã€‚

# SIMD å’Œ SSE/AVX {#csimd}

SIMD (Single Instruction, Multiple Data)ï¼Œå³å•æŒ‡ä»¤å¤šæ•°æ®ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯é€šè¿‡ä¸€æ¡æŒ‡ä»¤å¯¹å¤šæ¡æ•°æ®è¿›è¡ŒåŒæ—¶æ“ä½œã€‚æ®ç»´åŸºç™¾ç§‘è¯´ï¼Œæœ€æ—©å¾—åˆ°å¹¿æ³›åº”ç”¨çš„SIMDæŒ‡ä»¤é›†æ˜¯Intelçš„MMXæŒ‡ä»¤é›†ï¼Œå…±åŒ…å«57æ¡æŒ‡ä»¤ã€‚MMXæä¾›äº†8ä¸ª64ä½çš„å¯„å­˜å™¨(MM0 - MM7)ï¼Œæ¯ä¸ªå¯„å­˜å™¨å¯ä»¥å­˜æ”¾ä¸¤ä¸ª32ä½æ•´æ•°æˆ–4ä¸ª16ä½æ•´æ•°æˆ–8ä¸ª8ä½æ•´æ•°ï¼Œå¯„å­˜å™¨ä¸­â€œæ‰“åŒ…â€çš„å¤šä¸ªæ•°æ®å¯ä»¥é€šè¿‡ä¸€æ¡æŒ‡ä»¤åŒæ—¶å¤„ç†ï¼Œä¸å†éœ€è¦åˆ†æˆå‡ æ¬¡åˆ†åˆ«å¤„ç†ã€‚

> ä¾‹å¦‚åš8ä¸ª8ä½æ•´æ•°åŠ æ³•(c[i] = a[i] + b[i]. i âˆˆ {0,1,...,7})ã€‚  
>    
>> æ ‡é‡ç®—æ³•æµç¨‹ï¼š  
i = 0    
å°†a[i]è¯»å…¥å¯„å­˜å™¨0    
å°†b[i]è¯»å…¥å¯„å­˜å™¨1    
å¯¹å¯„å­˜å™¨0å’Œ1å†…çš„8ä½æ•´æ•°æ±‚å’Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨å¯„å­˜å™¨0ä¸­    
å°†å¯„å­˜å™¨0ä¸­çš„å…«ä½æ•´æ•°å†™å…¥c[i]çš„å†…å­˜ä½ç½®    
i = i+1    
æ¯”è¾ƒiå’Œ8    
å¦‚æœå°äºåˆ™é‡å¤ä»¥ä¸Šæ­¥éª¤    
>    
>> çŸ¢é‡ç®—æ³•æµç¨‹ï¼š    
å°†a[0-7]è¯»å…¥çŸ¢é‡å¯„å­˜å™¨0    
å°†b[0-7]è¯»å…¥çŸ¢é‡å¯„å­˜å™¨1    
å¯¹çŸ¢é‡å¯„å­˜å™¨0å’Œ1æŒ‰ç…§8ä½ä¸€ä¸ªæ•´æ•°åŒæ—¶æ±‚å’Œï¼Œç»“æœå­˜å‚¨åœ¨çŸ¢é‡å¯„å­˜å™¨0ä¸­    
å°†é€‚é‡å¯„å­˜å™¨0ä¸­çš„64ä½æ•°æ®å†™å…¥cçš„å†…å­˜ä½ç½®    

å¦‚ä¸Šä¾‹ï¼Œå¯¹äº8ä½æ•´æ•°çš„åŠ æ³•ï¼Œç†è®ºä¸Šæœ€å¤§å¯ä»¥æœ‰8å€çš„æé€Ÿã€‚

ä¹‹åï¼ŒSSEå‡ºç°äº†ï¼Œæä¾›äº†8ä¸ª128ä½å¯„å­˜å™¨(XMM0 - XMM7)ï¼Œå¹¶ä¸”æœ‰äº†å¤„ç†æµ®ç‚¹æ•°çš„èƒ½åŠ›ã€‚å¯ä»¥åŒæ—¶å¤„ç†ä¸¤ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°æˆ–å››ä¸ªå•ç²¾åº¦æµ®ç‚¹æ•°ï¼Œæˆ–è€…åŒæ—¶å¤„ç†å››ä¸ª32ä½æ•´æ•°æˆ–è€…å…«ä¸ª16ä½æ•´æ•°åˆæˆ–è€…åå…­ä¸ª8ä½æ•´æ•°ã€‚

å†åæ¥ï¼Œåˆå‡çº§äº†AVXã€‚AVXå°†SSEçš„æ¯ä¸ª128ä½å¯„å­˜å™¨æ‰©å±•åˆ°256ä½ï¼Œå¹¶å¢åŠ äº†8ä¸ª256å¯„å­˜å™¨ã€‚16ä¸ª256ä½å¯„å­˜å™¨ç§°ä½œ(YMM0 - YMM15)ã€‚å†åæ¥Intelåˆæ¨å‡ºäº†AVX512ï¼ŒæŠŠYMMæ‰©å±•åˆ°512ä½ï¼Œåˆæ–°å¢16ä¸ªå¯„å­˜å™¨ï¼Œå…±32ä¸ª512ä½å¯„å­˜å™¨(ZMM0 - ZMM31)ã€‚(å‰å‡ å¤©Linusè¿˜æ€’æ–¥äº†Intelçš„AVX512ğŸ¤£)

x40æœåŠ¡å™¨æ˜¯æ”¯æŒAVX512çš„ï¼Œä½†æ˜¯æœ¬æŒ‡å—ä¸ä»‹ç»AVX512ä½¿ç”¨æ–¹æ³•(ä¸»è¦æ˜¯å› ä¸ºæˆ‘ä¹Ÿæ²¡ç”¨è¿‡)ã€‚ä½†æ˜¯åŸåˆ™ä¸Šä¸AVXå¤§åŒå°å¼‚ã€‚è€Œä¸”ï¼Œå¤§æ¦‚ç‡æ‚¨æ­£åœ¨ä½¿ç”¨çš„æ¡Œé¢ç”µè„‘æˆ–ç¬”è®°æœ¬ç”µè„‘ä¹Ÿæ”¯æŒAVXæŒ‡ä»¤é›†ï¼Œä½†ä¸å¤§å¯èƒ½æ”¯æŒAVX512ï¼Œå› æ­¤æœ¬ç« çš„ä»£ç æ‚¨å¯ä»¥åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šè¿è¡Œ/æµ‹è¯•ã€‚

## ä¸€ä¸ªç®€å•çš„ç¨‹åº {#muladd_base}

> _å˜ç´”ãªé¦¬é¹¿ã«ã‚ã‚ŠãŸã„ã€‚â€”â€”ã€æ—¥å¸¸ã€_

ä¸ºä¾¿äºæ¼”ç¤ºSIMDå¹¶æ¯”è¾ƒé€Ÿåº¦ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªéå¸¸éå¸¸ç®€å•çš„ç¨‹åºï¼šæ‹¿ä¸‰ä¸ªdoubleæ•°ç»„ï¼Œç¬¬ä¸€ç»„ä¹˜ä¸Šç¬¬äºŒç»„å†åŠ ä¸Šç¬¬ä¸‰ç»„ï¼Œç»“æœå­˜å‚¨åœ¨ç¬¬å››ä¸ªæ•°ç»„ä¸­ã€‚æƒ³å¿…å„ä½è¯»è€…éƒ½èƒ½å¾ˆå¿«å®ç°è¿™æ ·çš„ç®—æ³•ã€‚ä¸‹é¢åˆ—å‡ºæœ¬æŒ‡å—ä½¿ç”¨çš„ç¨‹åºï¼ˆåç»­ç« èŠ‚ä¼šåŸºäºè¿™ä¸ªç¨‹åºè¿›è¡Œæ”¹é€ ï¼‰ã€‚ä¸ºäº†åŠ å¤§å¤„ç†å‹åŠ›ï¼Œä½¿è¿è¡Œæ—¶é—´å¯ä»¥è§‚æµ‹åˆ°ï¼Œè¿™é‡Œå¼ºè¡Œè®©ç¨‹åºç®—1,000,000éã€‚å¯ä»¥åœ¨è¾“å‡ºä¸­çœ‹åˆ°è®¡ç®—è€—æ—¶åœ¨10så·¦å³ã€‚åœ¨è¾“å‡ºè¿è¡Œæ—¶é—´åï¼ŒæŒ‘å‡ºä¸€äº›ç»“æœæ¥å¯¹ç…§ä¸€ä¸‹çœ‹çœ‹å¯¹ä¸å¯¹ï¼ˆå—¯ï¼Œåœ¨è¿™ä¸ªç¨‹åºé‡Œä¸Šé¢å’Œä¸‹é¢ä¸€æ¯›ä¸€æ ·ï¼Œæ€ä¹ˆä¼šä¸å¯¹å‘¢ï¼ï¼‰

```{c muladd.c, eval=FALSE}
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

__attribute__ ((noinline))
void muladd(double* a, double* b, double* c,
            double* d, unsigned long long N){
    unsigned long long i;
    for(i = 0; i < N; i++){
        d[i] = a[i] * b[i] + c[i];
    }
}

int main(){
    double* a; 
    double* b; 
    double* c; 
    double* d;

    a = (double*)(malloc(8192*sizeof(double)));
    b = (double*)(malloc(8192*sizeof(double)));
    c = (double*)(malloc(8192*sizeof(double)));
    d = (double*)(malloc(8192*sizeof(double)));

    //Prepare data
    unsigned long long i;
    for(i = 0; i < 8192; i++){
        a[i] = (double)(rand()%2000) / 200.0;
        b[i] = (double)(rand()%2000) / 200.0;
        c[i] = ((double)i)/10000.0;
    }
    
    clock_t start, stop;
    double elapsed;
    start = clock();

    for(i = 0; i < 1000000; i++){
        muladd(a, b, c, d, 8192);
    }

    stop = clock();
    elapsed = (double)(stop-start) / CLOCKS_PER_SEC;
    printf("Elapsed time = %8.6f s\n", elapsed);
    for(i = 0; i < 8192; i++){
        if(i % 1001 == 0){
            printf("%5llu: %12.8f * %12.8f + %12.8f = %12.8f (%d)\n",
                   i, a[i], b[i], c[i], d[i], d[i]==a[i]*b[i]+c[i]);
        }
    }

    free(a);
    free(b);
    free(c);
    free(d);
}

```

> å…³äºç¨‹åºéšä¾¿æä¸€å¥ã€‚`__attribute__ ((noinline))`çš„ä½œç”¨æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦å¯¹è¿™ä¸ªå‡½æ•°inlineå±•å¼€ã€‚å› ä¸ºæˆ‘ä»¬çš„muladdå‡½æ•°æ¯”è¾ƒç®€å•ï¼Œå¯èƒ½ä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–ä»¥åç›´æ¥åœ¨è°ƒç”¨å¤„åŸåœ°å±•å¼€ã€‚è™½ç„¶è¿™æ ·ä¹Ÿæ²¡ä»€ä¹ˆä¸è¡Œï¼Œä½†æ˜¯ä¸ºäº†åç»­åˆ†æç¨‹åºè¡Œä¸ºï¼Œè¿™é‡ŒåŠ ä¸Šäº†è¿™ä¸ªæ ‡å¿—ã€‚

ç¼–è¯‘è¿è¡Œä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è¿ç®—è¿‡ç¨‹èŠ±äº†20så·¦å³ã€‚

## æˆ‘çš„ç¬¬ä¸€ä¸ªSIMDç¨‹åºï¼ {#csimd_first}

> _May the 4s be with you._

æˆ‘ä»¬æ¥ä½¿ç”¨AVXï¼Œä¸€æ¬¡ç®—å››ä¸ªã€‚è¦æ˜¾å¼åœ°ä½¿ç”¨AVXæŒ‡ä»¤é›†ï¼Œå¯ä»¥ä½¿ç”¨æ‰€è°“â€œintrinsicâ€ã€‚è¿™äº›intrinsicä¸CPUæŒ‡ä»¤æœ‰ç›´æ¥çš„å¯¹åº”ã€‚å¯ä»¥å‚è€ƒ[Intel Intrinsics Guide](https://software.intel.com/sites/landingpage/IntrinsicsGuide/)ã€‚è¦ä½¿ç”¨è¿™äº›intrinsicï¼Œéœ€è¦`#include <x86intrin.h>`.
åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œè¿˜è¦åŠ ä¸Š`-mavx`

```{bash, eval=FALSE}
gcc -mavx -o muladd_simd muladd_simd.c
```

æ”¹é€ åçš„ç¨‹åºæ˜¯è¿™ä¸ªæ ·å­ï¼š

```{c muladd_simd.c, eval=FALSE}
#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <x86intrin.h>

__attribute__ ((noinline))
void muladd(double* a, double* b, double* c,
            double* d, unsigned long long N){
    unsigned long long i, j;
    unsigned long long M = N>>2;
    for(i = 0; i < M; i++){
        __m256d ymma = _mm256_load_pd(a+i*4);
        __m256d ymmb = _mm256_load_pd(b+i*4);
        __m256d ymmc = _mm256_load_pd(c+i*4);
        __m256d ymmd = _mm256_mul_pd(ymma, ymmb);
        ymmd = _mm256_add_pd(ymmd, ymmc);
        _mm256_store_pd(d+i*4,ymmd);
    }
    for(i = N-N%4; i < N; i++){
        d[i] = a[i] * b[i] + c[i];
    }
}

int main(){
    double* a; 
    double* b; 
    double* c; 
    double* d;

    a = (double*)(aligned_alloc(32,8192*sizeof(double)));
    b = (double*)(aligned_alloc(32,8192*sizeof(double)));
    c = (double*)(aligned_alloc(32,8192*sizeof(double)));
    d = (double*)(aligned_alloc(32,8192*sizeof(double)));

   //Prepare data
    unsigned long long i;
    for(i = 0; i < 8192; i++){
        a[i] = (double)(rand()%2000) / 200.0;
        b[i] = (double)(rand()%2000) / 200.0;
        c[i] = ((double)i)/10000.0;
    }
    
    clock_t start, stop;
    double elapsed;
    start = clock();
    
    for(i = 0; i < 1000000; i++){
        muladd(a, b, c, d, 8192);
    }

    stop = clock();
    elapsed = (double)(stop-start) / CLOCKS_PER_SEC;
    printf("Elapsed time = %8.6f s\n", elapsed);
    for(i = 0; i < 8192; i++){
        if(i % 1001 == 0){
            printf("%5llu: %16.8f * %16.8f + %16.8f = %16.8f (%d)\n",
                   i, a[i], b[i], c[i], d[i], d[i]==a[i]*b[i]+c[i]);
        }
    }

    free(a);
    free(b);
    free(c);
    free(d);
}


```

> å…³äºè¿™æ®µç¨‹åºåˆè¦æä¸€å¥ã€‚`malloc(8192*sizeof(double))`æ¢æˆäº†`aligned_alloc(32, 8192*sizeof(double))`. è¿™æ˜¯å› ä¸º`_mm256_load_pd`è¦æ±‚å†…å­˜æ˜¯å¯¹é½åˆ°256bitçš„(YMMå¯„å­˜å™¨çš„å®½åº¦æ˜¯256bit).`aligned_alloc`å‡½æ•°å¯ä»¥å®ç°å¼€è¾Ÿå¯¹é½åˆ°æŒ‡å®šåœ°å€çš„å†…å­˜ç©ºé—´ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯¹é½æ–¹å¼ï¼Œå•ä½æ˜¯å­—èŠ‚(Byte)(32Byte Ã— 8bit/byte = 256 bit)ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†…å­˜å¤§å°ã€‚è¦æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°å¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªçš„æ•´æ•°å€ã€‚    
å¦å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥`malloc`ï¼Œè€ŒæŠŠ`_mm256_load_pd`æ›¿æ¢ä¸º`_mm256_loadu_pd`ï¼ŒæŠŠ `_mm256_store_pd` æ›¿æ¢ä¸º `__mm256_storeu_pd`. uä»£è¡¨â€œunalignedâ€ã€‚    
>    
>> _ä»¥ä¸‹å¤ªé•¿ä¸çœ‹_  
è¯»å–åŒç²¾åº¦æµ®ç‚¹æ•°æ®åˆ°YMMæœ‰ä¸¤ä¸ªæŒ‡ä»¤ï¼ŒVMOVAPD å’Œ VMOVUPDã€‚VMOVAPDè¦æ±‚å†…å­˜åœ°å€æ˜¯å¯¹é½åˆ°256ä½çš„ï¼Œè€ŒVMOVUPDæ— æ­¤è¦æ±‚ã€‚æ®è¯´åœ¨æ—©æœŸçš„æ”¯æŒAVXçš„cpuä¸ŠVMOVAPDè¦å¿«ä¸€äº›ï¼Œä¼¼ä¹åœ¨æ–°ä¸€äº›çš„å¹³å°ä¸Šæ€§èƒ½å·²ç»ç›¸å½“äº†ã€‚ï¼ˆä½†æˆ‘æ²¡æœ‰è¯¦ç»†è€ƒè¯è¿‡ã€‚ï¼‰ä»¥åŠï¼Œ`_mm256_load_upd`ä¼¼ä¹å¹¶ä¸ä¼šè¢«ç¿»è¯‘ä¸ºvmovupdï¼Œè€Œæ˜¯å˜æˆäº†ä¸¤æ¡æŒ‡ä»¤ï¼Œå¤§è‡´æ˜¯å…ˆè¯»å…¥ä¸¤ä¸ªdoubleï¼Œå†æŠŠå¦å¤–ä¸¤ä¸ªæ’å…¥è¿›æ¥ã€‚emm...

èµ¶ç´§ç¼–è¯‘è¿è¡Œä¸€ä¸‹ï¼Œè¿™å›å¯å¿«äº†ï¼Œåªè¦â€¦â€¦å—¯ï¼Ÿè¦16sï¼Ÿ4ä¸ªdoubleåŒæ—¶ç®—ï¼Œè¿™æå‡ä¹Ÿå¤ªå°äº†å§ï¼Ÿå’±ä»¬çœ‹ä¸€ä¸‹ç¼–è¯‘å‡ºæ¥çš„å†…å®¹ï¼š
```{bash eval=FALSE}
$ gdb muladd_simd
  (gdb) disassemble muladd
  Dump of assembler code for function muladd:
   0x0000000000400657 <+0>:     lea    0x8(%rsp),%r10
   0x000000000040065c <+5>:     and    $0xffffffffffffffe0,%rsp
   0x0000000000400660 <+9>:     pushq  -0x8(%r10)
   0x0000000000400664 <+13>:    push   %rbp
   0x0000000000400665 <+14>:    mov    %rsp,%rbp
   0x0000000000400668 <+17>:    push   %r10
   0x000000000040066a <+19>:    sub    $0x150,%rsp
   0x0000000000400671 <+26>:    mov    %rdi,-0x198(%rbp)
   0x0000000000400678 <+33>:    mov    %rsi,-0x1a0(%rbp)
   0x000000000040067f <+40>:    mov    %rdx,-0x1a8(%rbp)
   0x0000000000400686 <+47>:    mov    %rcx,-0x1b0(%rbp)
   0x000000000040068d <+54>:    mov    %r8,-0x1b8(%rbp)
   0x0000000000400694 <+61>:    mov    -0x1b8(%rbp),%rax
   0x000000000040069b <+68>:    shr    $0x2,%rax
   0x000000000040069f <+72>:    mov    %rax,-0x20(%rbp)
   0x00000000004006a3 <+76>:    movq   $0x0,-0x18(%rbp)
   0x00000000004006ab <+84>:    jmpq   0x4007e5 <muladd+398>
   0x00000000004006b0 <+89>:    mov    -0x18(%rbp),%rax
   0x00000000004006b4 <+93>:    shl    $0x5,%rax
   0x00000000004006b8 <+97>:    mov    %rax,%rdx
   0x00000000004006bb <+100>:   mov    -0x198(%rbp),%rax
   0x00000000004006c2 <+107>:   add    %rdx,%rax
   0x00000000004006c5 <+110>:   mov    %rax,-0x188(%rbp)
   0x00000000004006cc <+117>:   mov    -0x188(%rbp),%rax
   0x00000000004006d3 <+124>:   vmovapd (%rax),%ymm0
   0x00000000004006d7 <+128>:   vmovapd %ymm0,-0x50(%rbp)
   0x00000000004006dc <+133>:   mov    -0x18(%rbp),%rax
   0x00000000004006e0 <+137>:   shl    $0x5,%rax
   0x00000000004006e4 <+141>:   mov    %rax,%rdx
   0x00000000004006e7 <+144>:   mov    -0x1a0(%rbp),%rax
   0x00000000004006ee <+151>:   add    %rdx,%rax
   0x00000000004006f1 <+154>:   mov    %rax,-0x180(%rbp)
   0x00000000004006f8 <+161>:   mov    -0x180(%rbp),%rax
   0x00000000004006ff <+168>:   vmovapd (%rax),%ymm0
   0x0000000000400703 <+172>:   vmovapd %ymm0,-0x70(%rbp)
   0x0000000000400708 <+177>:   mov    -0x18(%rbp),%rax
   0x000000000040070c <+181>:   shl    $0x5,%rax
   0x0000000000400710 <+185>:   mov    %rax,%rdx
   0x0000000000400713 <+188>:   mov    -0x1a8(%rbp),%rax
   0x000000000040071a <+195>:   add    %rdx,%rax
   0x000000000040071d <+198>:   mov    %rax,-0x178(%rbp)
   0x0000000000400724 <+205>:   mov    -0x178(%rbp),%rax
   0x000000000040072b <+212>:   vmovapd (%rax),%ymm0
   0x000000000040072f <+216>:   vmovapd %ymm0,-0x90(%rbp)
   0x0000000000400737 <+224>:   vmovapd -0x50(%rbp),%ymm0
   0x000000000040073c <+229>:   vmovapd %ymm0,-0x150(%rbp)
   0x0000000000400744 <+237>:   vmovapd -0x70(%rbp),%ymm0
   0x0000000000400749 <+242>:   vmovapd %ymm0,-0x170(%rbp)
   0x0000000000400751 <+250>:   vmovapd -0x150(%rbp),%ymm0
   0x0000000000400759 <+258>:   vmulpd -0x170(%rbp),%ymm0,%ymm0
   0x0000000000400761 <+266>:   vmovapd %ymm0,-0xb0(%rbp)
   0x0000000000400769 <+274>:   vmovapd -0xb0(%rbp),%ymm0
   0x0000000000400771 <+282>:   vmovapd %ymm0,-0x110(%rbp)
   0x0000000000400779 <+290>:   vmovapd -0x90(%rbp),%ymm0
   0x0000000000400781 <+298>:   vmovapd %ymm0,-0x130(%rbp)
   0x0000000000400789 <+306>:   vmovapd -0x110(%rbp),%ymm0
   0x0000000000400791 <+314>:   vaddpd -0x130(%rbp),%ymm0,%ymm0
   0x0000000000400799 <+322>:   vmovapd %ymm0,-0xb0(%rbp)
   0x00000000004007a1 <+330>:   mov    -0x18(%rbp),%rax
   0x00000000004007a5 <+334>:   shl    $0x5,%rax
   0x00000000004007a9 <+338>:   mov    %rax,%rdx
   0x00000000004007ac <+341>:   mov    -0x1b0(%rbp),%rax
   0x00000000004007b3 <+348>:   add    %rdx,%rax
   0x00000000004007b6 <+351>:   mov    %rax,-0xb8(%rbp)
   0x00000000004007bd <+358>:   vmovapd -0xb0(%rbp),%ymm0
   0x00000000004007c5 <+366>:   vmovapd %ymm0,-0xf0(%rbp)
   0x00000000004007cd <+374>:   mov    -0xb8(%rbp),%rax
   0x00000000004007d4 <+381>:   vmovapd -0xf0(%rbp),%ymm0
   0x00000000004007dc <+389>:   vmovapd %ymm0,(%rax)
   0x00000000004007e0 <+393>:   addq   $0x1,-0x18(%rbp)
   0x00000000004007e5 <+398>:   mov    -0x18(%rbp),%rax
   0x00000000004007e9 <+402>:   cmp    -0x20(%rbp),%rax
   0x00000000004007ed <+406>:   jb     0x4006b0 <muladd+89>
   0x00000000004007f3 <+412>:   mov    -0x1b8(%rbp),%rax
   0x00000000004007fa <+419>:   and    $0xfffffffffffffffc,%rax
   0x00000000004007fe <+423>:   mov    %rax,-0x18(%rbp)
   0x0000000000400802 <+427>:   jmp    0x400879 <muladd+546>
   0x0000000000400804 <+429>:   mov    -0x18(%rbp),%rax
   0x0000000000400808 <+433>:   lea    0x0(,%rax,8),%rdx
   0x0000000000400810 <+441>:   mov    -0x198(%rbp),%rax
   0x0000000000400817 <+448>:   add    %rdx,%rax
   0x000000000040081a <+451>:   vmovsd (%rax),%xmm1
   0x000000000040081e <+455>:   mov    -0x18(%rbp),%rax
   0x0000000000400822 <+459>:   lea    0x0(,%rax,8),%rdx
   0x000000000040082a <+467>:   mov    -0x1a0(%rbp),%rax
   0x0000000000400831 <+474>:   add    %rdx,%rax
   0x0000000000400834 <+477>:   vmovsd (%rax),%xmm0
   0x0000000000400838 <+481>:   vmulsd %xmm0,%xmm1,%xmm0
   0x000000000040083c <+485>:   mov    -0x18(%rbp),%rax
   0x0000000000400840 <+489>:   lea    0x0(,%rax,8),%rdx
   0x0000000000400848 <+497>:   mov    -0x1a8(%rbp),%rax
   0x000000000040084f <+504>:   add    %rdx,%rax
   0x0000000000400852 <+507>:   vmovsd (%rax),%xmm1
   0x0000000000400856 <+511>:   mov    -0x18(%rbp),%rax
   0x000000000040085a <+515>:   lea    0x0(,%rax,8),%rdx
   0x0000000000400862 <+523>:   mov    -0x1b0(%rbp),%rax
   0x0000000000400869 <+530>:   add    %rdx,%rax
   0x000000000040086c <+533>:   vaddsd %xmm1,%xmm0,%xmm0
   0x0000000000400870 <+537>:   vmovsd %xmm0,(%rax)
   0x0000000000400874 <+541>:   addq   $0x1,-0x18(%rbp)
   0x0000000000400879 <+546>:   mov    -0x18(%rbp),%rax
   0x000000000040087d <+550>:   cmp    -0x1b8(%rbp),%rax
   0x0000000000400884 <+557>:   jb     0x400804 <muladd+429>
   0x000000000040088a <+563>:   nop
   0x000000000040088b <+564>:   add    $0x150,%rsp
   0x0000000000400892 <+571>:   pop    %r10
   0x0000000000400894 <+573>:   pop    %rbp
   0x0000000000400895 <+574>:   lea    -0x8(%r10),%rsp
   0x0000000000400899 <+578>:   retq
End of assembler dump.
```

å¯¹æ¯”ä¸€ä¸‹æ ‡é‡ç‰ˆå¾—åˆ°çš„æ±‡ç¼–ï¼š

```{bash eval=FALSE}
$ gdb muladd
  (gdb) disassemble muladd
  Dump of assembler code for function muladd:
   0x0000000000400637 <+0>:     push   %rbp
   0x0000000000400638 <+1>:     mov    %rsp,%rbp
   0x000000000040063b <+4>:     mov    %rdi,-0x18(%rbp)
   0x000000000040063f <+8>:     mov    %rsi,-0x20(%rbp)
   0x0000000000400643 <+12>:    mov    %rdx,-0x28(%rbp)
   0x0000000000400647 <+16>:    mov    %rcx,-0x30(%rbp)
   0x000000000040064b <+20>:    mov    %r8,-0x38(%rbp)
   0x000000000040064f <+24>:    movq   $0x0,-0x8(%rbp)
   0x0000000000400657 <+32>:    jmp    0x4006c2 <muladd+139>
   0x0000000000400659 <+34>:    mov    -0x8(%rbp),%rax
   0x000000000040065d <+38>:    lea    0x0(,%rax,8),%rdx
   0x0000000000400665 <+46>:    mov    -0x18(%rbp),%rax
   0x0000000000400669 <+50>:    add    %rdx,%rax
   0x000000000040066c <+53>:    movsd  (%rax),%xmm1
   0x0000000000400670 <+57>:    mov    -0x8(%rbp),%rax
   0x0000000000400674 <+61>:    lea    0x0(,%rax,8),%rdx
   0x000000000040067c <+69>:    mov    -0x20(%rbp),%rax
   0x0000000000400680 <+73>:    add    %rdx,%rax
   0x0000000000400683 <+76>:    movsd  (%rax),%xmm0
   0x0000000000400687 <+80>:    mulsd  %xmm1,%xmm0
   0x000000000040068b <+84>:    mov    -0x8(%rbp),%rax
   0x000000000040068f <+88>:    lea    0x0(,%rax,8),%rdx
   0x0000000000400697 <+96>:    mov    -0x28(%rbp),%rax
   0x000000000040069b <+100>:   add    %rdx,%rax
   0x000000000040069e <+103>:   movsd  (%rax),%xmm1
   0x00000000004006a2 <+107>:   mov    -0x8(%rbp),%rax
   0x00000000004006a6 <+111>:   lea    0x0(,%rax,8),%rdx
   0x00000000004006ae <+119>:   mov    -0x30(%rbp),%rax
   0x00000000004006b2 <+123>:   add    %rdx,%rax
   0x00000000004006b5 <+126>:   addsd  %xmm1,%xmm0
   0x00000000004006b9 <+130>:   movsd  %xmm0,(%rax)
   0x00000000004006bd <+134>:   addq   $0x1,-0x8(%rbp)
   0x00000000004006c2 <+139>:   mov    -0x8(%rbp),%rax
   0x00000000004006c6 <+143>:   cmp    -0x38(%rbp),%rax
   0x00000000004006ca <+147>:   jb     0x400659 <muladd+34>
   0x00000000004006cc <+149>:   nop
   0x00000000004006cd <+150>:   pop    %rbp
   0x00000000004006ce <+151>:   retq
End of assembler dump.
```

å·®å¥½å¤šï¼ä»”ç»†çœ‹ä¸€ä¸‹ï¼ŒSIMDç‰ˆæœ¬ä¸­<+89>åˆ°<+128>è¿™éƒ¨åˆ†ã€‚ç®€å•è§£é‡Šä¸€ä¸‹ï¼š

|  <ä½ç½®>   |  æ±‡ç¼–                              |  å«ä¹‰                      |
|-----------|------------------------------------|----------------------------|
| < +89>    | mov    -0x18(%rbp),%rax            | å°†å¾ªç¯å˜é‡(i) è¯»å…¥å¯„å­˜å™¨rax|
| < +93>    | shl    $0x5,%rax                   | raxä¸­çš„æ•°å·¦ç§»5ä½(ç›¸å½“äº*32).|
| < +97>    | mov    %rax,%rdx                   | å°†raxä¸­çš„æ•°æ‹·è´åˆ°rdxå¯„å­˜å™¨ä¸­|
| <+100>    | mov    -0x198(%rbp),%rax           | å°†æ•°ç»„Açš„åœ°å€è¯»å…¥å¯„å­˜å™¨rax |
| <+107>    | add    %rdx,%rax                   | rax = rax + rdx            |
| <+124>    | vmovapd (%rax),%ymm0               | ä»raxå¯„å­˜å™¨æ‰€ç¤ºåœ°å€å¤„è¯»å–256ä½åˆ°YMM0|
| <+128>    | vmovapd %ymm0,-0x50(%rbp)          | å°†YMM0ä¸­çš„æ•°æ®ä¿å­˜åœ¨æ ˆä¸Šçš„ä¸€ä¸ªä½ç½®|

> å¦‚æœæ‚¨æ›¾ç»å­¦ä¹ è¿‡ã€Šæ±‡ç¼–è¯­è¨€ç¨‹åºè®¾è®¡ã€‹æˆ–è€…ã€Šå¾®æœºåŸç†ã€‹ç­‰è¯¾ç¨‹ï¼Œå¯èƒ½ä¼šå¯¹ä¸Šè¿°æ±‡ç¼–ä»£ç æœ‰ç–‘é—®ã€‚è¿™æ˜¯ç”±äºé€šå¸¸å¾®æœºåŸç†è¯¾ç¨‹ä½¿ç”¨çš„æ˜¯Intel æ ¼å¼çš„æ±‡ç¼–(ins dst, src)ï¼Œè€ŒGCCä½¿ç”¨AT&Tæ ¼å¼(ins src, dst)ï¼Œä¸€èˆ¬æ¥è®²æ“ä½œæ•°çš„é¡ºåºå’ŒIntelæ ¼å¼éƒ½æ˜¯åè¿‡æ¥çš„ã€‚    
å¦‚æœæ‚¨å¹¶ä¸æ‡‚æ±‡ç¼–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥çœ‹ç»“è®ºã€‚å¦‚æœå¯¹æ±‡ç¼–æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒé™„å½•ã€‚

ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ¯ä¸€æ¬¡å¾ªç¯æŠŠéœ€è¦çš„å€¼å–åˆ°å¯„å­˜å™¨ä¸­ï¼Œå†å­˜åˆ°æ ˆä¸Š(å¯ä»¥ç†è§£ä¸ºå‡½æ•°è‡ªæœ‰çš„å†…å­˜)ã€‚ä¸‰ä¸ªæ•°æ®éƒ½å­˜å¥½åï¼Œå†æŠŠä»–ä»¬ä¾æ¬¡ä»æ ˆé‡Œå–åˆ°ä¸åŒçš„YMMå¯„å­˜å™¨é‡Œï¼Œåšæ±‚ç§¯å’Œæ±‚å’Œï¼Œå†å­˜åˆ°ç›¸åº”ä½ç½®ã€‚ï¼ˆè¿™åªæ˜¯å¤§è‡´è¿‡ç¨‹ï¼Œå®é™…çœ‹ä¸€çœ‹ï¼Œå®ƒå¹²çš„å‚»äº‹è¿˜ä¸å°‘ï¼‰ã€‚

ä»”ç»†æƒ³æƒ³ï¼Œå…¶å®ç¼–è¯‘å™¨è¿™ä¹ˆåšæ˜¯æœ‰é“ç†çš„ã€‚åœ¨ç¨‹åºé‡Œï¼Œæˆ‘ä»¬å†™äº†`__m256d ymma = _mm256_load_pd(a+i*4);`ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬è¦æœ‰ä¸€ä¸ª`ymma`å˜é‡ã€‚ç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“æˆ‘ä»¬ä¼šä¸ä¼šå¯¹è¿™ä¸ªå˜é‡åš Â·ä¸€Â·äº›Â·å¥‡Â·æ€ªÂ·çš„Â·äº‹Â· å› æ­¤ä¾¿æŠŠå®ƒåˆå†™è¿›äº†æ ˆé‡Œã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•è®©ç¼–è¯‘å™¨æ˜ç™½æˆ‘ä»¬ä¸ä¼šä¹±åŠ¨`ymma`å‘¢ï¼Ÿæœ‰ï¼

## æä¸ªå¯„å­˜å™¨å˜é‡ {#csimd_reg}

> _æˆ‘ä¹°å‡ ä¸ªæ©˜å­å»ã€‚ä½ å°±åœ¨æ­¤åœ°ï¼Œä¸è¦èµ°åŠ¨ã€‚â€”â€”ã€ŠèƒŒå½±ã€‹_    

åªè¦åœ¨å£°æ˜å˜é‡çš„æ—¶å€™ï¼Œåœ¨ç±»å‹å‰é¢åŠ ä¸Š`register`å…³é”®å­—ï¼Œç¼–è¯‘å™¨å°±æ˜ç™½è¿™ä¸ªä¸œè¥¿åº”è¯¥å¸¸é©»åœ¨å¯„å­˜å™¨é‡Œé¢ï¼Œå°±ä¸ä¼šæ¥å›è¯»å†™å†…å­˜äº†ã€‚éœ€è¦æ³¨æ„**ä¸èƒ½å¯¹å¯„å­˜å™¨å˜é‡å–åœ°å€ï¼**é¡ºä¾¿ï¼Œè¿™ä¸ªæµ“çœ‰å¤§çœ¼çš„å¾ªç¯æ¬¡æ•°ä¹Ÿå¯ä»¥æ”¾åˆ°å¯„å­˜å™¨é‡Œé¢çš„æ ·å­ï¼ŒæŠŠè¿™äº›ä¸œè¥¿åŠ ä¸Š`register`å…³é”®å­—ï¼š
```{c muladd_simd_r.cç‰‡æ®µ, eval=F}
    register unsigned long long M = N>>2;
    for(i = 0; i < M; i++){
        register __m256d ymma = _mm256_load_pd(a+i*4);
        register __m256d ymmb = _mm256_load_pd(b+i*4);
        register __m256d ymmc = _mm256_load_pd(c+i*4);
        register __m256d ymmd = _mm256_mul_pd(ymma, ymmb);
        ymmd = _mm256_add_pd(ymmd, ymmc);
        _mm256_store_pd(d+i*4,ymmd);
    }
```

å†æ¥è¿è¡Œä¸‹ã€‚**åˆ«å¿˜äº†ç¼–è¯‘æ—¶åŠ -mavx**        
å¤§æ¦‚12ç§’å·¦å³ã€‚å·²ç»æ¯”æœ€åŸå§‹çš„ç‰ˆæœ¬å¿«äº†è¿‘ä¸€å€äº†!å››èˆäº”å…¥ä¸€ä¸ªäº¿å•Šï¼

> åœ¨æ–°æ ‡å‡†çš„c++ä¸­ï¼Œæ®è¯´registerå…³é”®å­—å·²ç»æ²¡æœ‰æ„ä¹‰äº†ï¼ŒåŠ äº†registerç¼–è¯‘å™¨ä¹Ÿä¸ä¸€å®šç”¨å¯„å­˜å™¨ï¼Œä¸åŠ ä¹Ÿä¸ä¸€å®šå°±ä¸ç”¨ã€‚ä½†æ˜¯åœ¨æˆ‘ç”¨c++æµ‹è¯•çš„æ—¶å€™ï¼Œå‘ç°è¿˜æ˜¯æœ‰ç”¨çš„ã€‚    
åœ¨g++é‡Œå¢åŠ `-std=c++11`æˆ–è€…`-std=c++14`éƒ½å¯ä»¥é¡ºåˆ©ç¼–è¯‘ï¼Œè¿è¡Œé€Ÿåº¦ä¸€è‡´ã€‚å¦‚æœåŠ `-std=c++17`åˆ™ä¼šæŠ¥å‡ ä¸ªwarningï¼Œè¯´æ˜¯æ–°æ ‡å‡†ä¸è®¸regesterï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šæ¯”ä¸åŠ registerå…³é”®å­—è¦å¿«ã€‚ï¼ˆå•Šå“ˆï¼Œä½ ä¸ªc++17ï¼Œå˜´ä¸Šè¯´ç€warningï¼Œèº«ä½“å€’æ˜¯å¾ˆè€å®å˜›ï¼ï¼‰

## æˆ‘æ¯”ç¼–è¯‘å™¨èªæ˜ç³»åˆ— {#csimd_asm}

> _ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚‚ã€å¤©å›½ã¸ã„ã‘ã‚‹ã‹ãªã€‚â€”â€”ã€Lost Universeã€_

è¿˜èƒ½ä¸èƒ½å†å¿«ä¸€ç‚¹ï¼Ÿæˆ‘æƒ³è¦çš„å››å€æé€Ÿå‘¢ï¼Ÿ    
ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨cè¯­è¨€çš„å†…è”æ±‡ç¼–åšè¿™ä»¶äº‹ã€‚

```{c muladd_simd_asm.cç‰‡æ®µ, eval=FALSE}
__attribute__ ((noinline))
void muladd(double* a, double* b, double* c,
            double* d, unsigned long long N){
    unsigned long long i;
    __asm__ __volatile__(
            "movq %0, %%rax \n\t"
            "movq %1, %%rbx \n\t"
            "movq %2, %%rcx \n\t"
            "movq %3, %%rdx \n\t"
            "movq %4, %%r8  \n\t"
            "shr  $2, %%r8  \n\t"
            "movq $0, %%r9  \n\t"
            "jmp  .check_%= \n\t"
            ".loop_%=:         \n\t"
            "shl $2, %%r9   \n\t"
            "vmovupd (%%rax, %%r9, 8), %%ymm0 \n\t"
            "vmovupd (%%rbx, %%r9, 8), %%ymm1 \n\t"
            "vmovupd (%%rcx, %%r9, 8), %%ymm2 \n\t"
            "vmulpd %%ymm0, %%ymm1, %%ymm3    \n\t"
            "vaddpd %%ymm2, %%ymm3, %%ymm3    \n\t"
            "vmovupd %%ymm3, (%%rdx, %%r9, 8) \n\t"
            "shr $2, %%r9                  \n\t"
            "add $1, %%r9                  \n\t"
            ".check_%=:                    \n\t"
            "cmpq %%r8, %%r9               \n\t"
            "jl .loop_%=                   \n\t"
            :
            :"m"(a), "m"(b), "m"(c), "m"(d), "m"(N)
            :"%rax", "%rbx", "%rcx", "%rdx", "%r8", "%r9",
             "%ymm0", "%ymm1", "%ymm2", "%ymm3", "memory"
            );
    if(N%4!=0){
        for(i = N-N%4; i<N; i++){
            d[i] = a[i]*b[i]+c[i];
        }
    }
}
```

> å…³äºå†…è”æ±‡ç¼–çš„ä»‹ç»ï¼Œè¯·å‚è§é™„å½•ã€‚è¿™é‡Œç”¨ä¸€æ®µæ±‡ç¼–ä»£æ›¿äº†å‰é¢çš„å¾ªç¯éƒ¨åˆ†ã€‚å½“Nä¸æ˜¯4çš„æ•´æ•°å€æ—¶ä½™ä¸‹çš„1-3ä¸ªè¿ç®—ä½¿ç”¨æ™®é€šcä»£ç ï¼Œå¹¶ä¸ä¼šå¯¹æ€§èƒ½äº§ç”Ÿå¤ªå¤§å½±å“ã€‚ä»¥åŠï¼Œè¿™æ¬¡ç¼–è¯‘ä¸éœ€è¦`-mavx`äº†ã€‚

ç¼–è¯‘ï¼Œè¿è¡Œä¸€ä¸‹ã€‚ä¸åˆ°4sï¼è¾¾åˆ°äº†é¢„æœŸçš„é€Ÿåº¦ã€‚

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥æ‰¾ä¸€ä¸‹AVX512æŒ‡ä»¤æ€ä¹ˆå†™ï¼ˆå…¶å®è·ŸAVXæ˜¯åŸºæœ¬ä¸€æ ·çš„ï¼‰ï¼Œè·å¾—è¿›ä¸€æ­¥åŠ é€Ÿã€‚

## ç¼–è¯‘å™¨æ¯”æˆ‘èªæ˜ç³»åˆ— {#csimd_gccO3}

> _Doing nothing often leads to the very best something.â€”â€”Winnie-the-Pooh_

è™½ç„¶è¿™é‡Œæ‰‹å†™äº†æ±‡ç¼–ï¼Œä½†æ˜¯åœ¨ä¸€èˆ¬çš„ç¨‹åºé‡Œä¸å»ºè®®è¿™ä¹ˆåšï¼Œé™¤éæœ‰ä¿¡å¿ƒåšå¾—å¥½å¹¶ä¸”èƒ½åŠ é€Ÿã€‚

å®æµ‹ï¼Œ`gcc -mavx -O3 -o muladd muladd.c`ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºä¸ä¸Šè¿°å†…è”æ±‡ç¼–çš„ç¨‹åºé€Ÿåº¦ç›¸å·®æ— å‡ ã€‚åœ¨`-O3`ä¼˜åŒ–ä¸‹gccæ˜¯æœ‰çŸ¢é‡åŒ–ä¼˜åŒ–çš„ï¼Œä¹Ÿæ˜¯æŠŠè¿ç®—ä¼˜åŒ–åˆ°äº†å››ä¸ªä¸€ç»„åŒæ—¶åšã€‚

åŒç†ï¼Œ`gcc -mavx512f -O3 -o muladd muladd.c`ä¼šè¿›è¡ŒAVX512çŸ¢é‡åŒ–ï¼Œå…«ä¸ªä¸€ç»„ï¼Œå†å¿«ä¸€å€ï¼ˆå¯èƒ½ä¸åˆ°ç‚¹ä¸€å€ï¼‰ã€‚

æ­¤å¤–ï¼Œä½¿ç”¨intrinsicçš„åŒæ—¶ï¼Œå¦‚æœæ‰“å¼€`-O2`ä¼˜åŒ–ï¼Œé€Ÿåº¦ä¹Ÿä¼šå¾ˆå¿«ï¼Œç”šè‡³æ¯”æ‰‹å†™æ±‡ç¼–å¿«é‚£ä¹ˆä¸€ç‚¹ã€‚çœ‹ä¸€ä¸‹åæ±‡ç¼–ï¼Œæ˜¯å°‘äº†ä¸€äº›å–æ•°åˆ°å¯„å­˜å™¨çš„æ“ä½œï¼ˆå¥½å§æˆ‘æ‰¿è®¤æˆ‘å­¦è‰ºä¸ç²¾ï¼‰ã€‚ä½†æ˜¯`-O2`ä¼˜åŒ–æœ¬èº«æ˜¯ä¸è¿›è¡ŒçŸ¢é‡åŒ–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨`-O2`ä¼˜åŒ–ä¸‹å¦‚æœä½¿ç”¨æˆ‘ä»¬æœ€å¼€å§‹çš„`muladd.c`çš„è¯æ˜¯åˆ©ç”¨ä¸åˆ°SIMDæ¥åŠ é€Ÿçš„ã€‚å› æ­¤ç”¨`-O2`é…åˆintrinsicå¯èƒ½æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚

> é¡ºä¾¿æä¸€ä¸‹ï¼Œæ— è®ºæ˜¯æ±‡ç¼–è¿˜æ˜¯intrinsicï¼Œå¯è¯»æ€§éƒ½æ¯”è¾ƒå·®ï¼Œæœ€å¥½å¤šåŠ ä¸€äº›æ³¨é‡Šã€‚

## æœ¬ç« å°ç»“ {#csimd_sum}

SIMDå¤§æ¦‚æ˜¯ç²’åº¦æœ€å°çš„å¹¶è¡Œäº†å§ï¼Ÿå¦‚åŒä¸Šé¢çš„ä¾‹å­ï¼Œé€‚å½“ä½¿ç”¨å·²ç»å¯ä»¥æå¤§åœ°æé«˜ç¨‹åºè¿è¡Œé€Ÿåº¦äº†ã€‚    

è¦æ³¨æ„ä¸€ç‚¹ï¼Œè¿™é‡Œé¢â€œçŸ¢é‡è¿ç®—â€åªæ˜¯åŒæ—¶åšå¥½å‡ ä¸ªè¿ç®—åœ°æ„æ€ï¼Œå¦‚æœä½ æƒ³çœŸçš„æŠŠå®ƒå½“ä½œçŸ¢é‡ï¼Œç”šè‡³æƒ³æ±‚ä¸ªå¤–ç§¯ï¼Œé‚£å°±è¶…å‡ºå¤„ç†å™¨çš„èƒ½åŠ›èŒƒå›´äº†ã€‚åªèƒ½æŠŠå¤–ç§¯è¿ç®—åˆ†è§£æˆåŠ å‡ä¹˜é™¤å†è¿›è¡Œè®¡ç®—ã€‚

è¿™ä¸€ç« åˆ°è¿™é‡Œå°±åº”è¯¥ç»“æŸäº†ï¼Œä½†æˆ‘è§‰å¾—é˜…è¯»æŒ‡å—çš„ä½ è„‘ä¸­ä¸€å®šå……æ»¡äº†é—®å·ã€‚æ‰€ä»¥åœ¨è¿™é‡Œå°è¯•è‡ªé—®è‡ªç­”ä¸€ä¸‹ã€‚

--------

**é—®ï¼šä¸ºä»€ä¹ˆè¦åš1,000,000æ¬¡8192ç»´æ•°ç»„çš„è¿ç®—ï¼Œè€Œä¸ç›´æ¥ç”¨8,192,000,000ç»´çš„æ•°ç»„ï¼Ÿ**    

ç­”ï¼šæ˜¯çš„ã€‚åœ¨æˆ‘åˆ¶ä½œè¿™ä»½æŒ‡å—ä¹‹å‰ä¹Ÿæ˜¯è¿™ä¹ˆæƒ³çš„ã€‚ä½†æ˜¯å‘ç°SIMDä»¥åé€Ÿåº¦å¹¶æ²¡æœ‰æé«˜ã€‚ç»æŸ¥ï¼Œå‘ç°åŸç†åœ¨äºå†…å­˜å¸¦å®½åƒæ»¡äº†ã€‚è™½ç„¶å¤„ç†å™¨å¯ä»¥ç®—å¾—é£å¿«ï¼Œä½†æ˜¯å†…å­˜é€Ÿåº¦è·Ÿä¸ä¸Šå¯¼è‡´é€Ÿåº¦è¢«é™åˆ¶äº†ï¼Œå› æ­¤çŸ¢é‡ç®—æ³•å’Œæ ‡é‡ç®—æ³•é€Ÿåº¦ç›¸è¿‘ã€‚è€Œå‡å°æ•°æ®è§„æ¨¡ä»¥åï¼Œ8192ä¸ªdoubleéƒ½ä¼šå­˜å‚¨åœ¨CPUçš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œè¿™æ ·å°±é¿å…äº†å†…å­˜å¸¦å®½çš„é™åˆ¶ï¼Œä»è€Œå¯ä»¥æ¯”è¾ƒå‘é‡å’Œæ ‡é‡æŒ‡ä»¤çš„é€Ÿåº¦å·®å¼‚ã€‚    
åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¯¹æ•°æ®çš„å¤„ç†æ˜¾ç„¶ä¸åªæ˜¯å…ˆæ±‚ç§¯å†æ±‚å’Œè¿™ç§ç®€å•è¿ç®—ã€‚éšç€è¿ç®—å˜å¾—å¤æ‚ï¼Œå½“å¤„ç†æ•°æ®çš„æ—¶é—´è¾¾åˆ°ç”šè‡³è¶…è¿‡å†…å­˜å­˜å–ç”¨æ—¶çš„æ—¶å€™ï¼ŒSIMDçš„æé€Ÿæ•ˆæœè‡ªç„¶å°±å¯ä»¥ä½“ç°å‡ºæ¥äº†ã€‚

æ­¤å¤–ï¼Œ$8,192,000,000 double \times 8 Byte/double = 65536 \times 10^{6} Byte \approx 64GB$åƒå†…å­˜ç¨å¾®æœ‰ç‚¹å¤§ã€‚

--------

**é—®ï¼šæ—¢ç„¶gccå¯ä»¥ä¼˜åŒ–å¾—è¿™ä¹ˆå¥½ï¼Œæè¿™ä¹ˆå¤æ‚å°±æ²¡æœ‰æ„ä¹‰äº†å§ï¼Ÿ**

ç­”ï¼šè¿™å¯ä¸å¥½è¯´äº†ã€‚åœ¨å¾ˆä¹…ä»¥å‰ï¼Œå¬è¯´gccçš„-O3æœ‰å¯èƒ½ä¼šæå‡ºè«åå…¶å¦™çš„bugã€‚è™½ç„¶æˆ‘æ²¡é‡åˆ°è¿‡è¿™ç§æƒ…å†µï¼Œè™½ç„¶è¿™ç§æƒ…å†µè‚¯å®šéå¸¸å°‘è§ï¼Œä½†æ˜¯æ€»çš„æ¥è¯´ç»™äººä¸€ç§ä¸å¤ªå¯é çš„æ„Ÿè§‰ã€‚æ­¤å¤–ï¼Œçº¯å‡­ä¸ªäººæ„Ÿè§‰ï¼Œå¯èƒ½gccçš„ä¼˜åŒ–åŠ›é‡ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œå¦‚æœè®¡ç®—è¿‡ç¨‹æ¯”è¾ƒé•¿æ¯”è¾ƒå¤æ‚ï¼Œå¯èƒ½gccå¹¶ä¸ä¸€å®šèƒ½é€‰å‡ºæœ€åˆé€‚çš„ä¼˜åŒ–æ–¹æ³•ï¼ˆå¯èƒ½ä¼šæ‰¾ä¸åˆ°æ•°æ®/å˜é‡ä¹‹é—´çš„å…³è”ï¼Ÿï¼‰ã€‚è¿˜æœ‰ï¼Œå¦‚æœä½ çš„ç¨‹åºä¸ä½¿ç”¨C/C++çš„è¯ï¼Œè¿˜æœ‰ä¸€å®šçš„å¯èƒ½ä½ çš„ç¼–è¯‘å™¨å¹¶ä¸æ”¯æŒAVXï¼Œè¿™æ—¶å°±è¦è‡ªå·±åŠ¨æ‰‹ä¸°è¡£è¶³é£Ÿï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ç”¨C/C++æä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ï¼‰ã€‚å¦å¤–`-O2`ä¸ä¼šè‡ªåŠ¨è¿›è¡ŒçŸ¢é‡åŒ–ï¼Œæ‰€ä»¥è‡³å°‘intrinsicåœ¨`-O2`ä¸‹è¿˜æ˜¯æœ‰æ„ä¹‰çš„ã€‚ä¸å¼€ä¼˜åŒ–å¼€å…³çš„è¯ï¼Œè¿˜æ˜¯è¦æ±‡ç¼–æ‰å¿«ä¸€äº›ã€‚å…·ä½“æ€ä¹ˆå†™ä»£ç ç”¨ä»€ä¹ˆä¼˜åŒ–è¿˜æ˜¯è¦è‡ªå·±å–èˆã€‚

--------

**é—®ï¼šä½œè€…ä½ å¥½å‰å®³å“¦ï¼å’‹å•¥éƒ½æ‡‚ï¼Ÿ**

ç­”ï¼šæ­£å¸¸å°æœ‹å‹ä¸€èˆ¬é—®ä¸å‡ºæ¥è¿™ç§é—®é¢˜ã€‚

## è¡¥å……å†…å®¹ {#csimd_add}

åœ¨è¿™é‡Œè¡¥å……ä¸€äº›æ¯”è¾ƒå¸¸ç”¨(å¤§æ¦‚)çš„AVXæŒ‡ä»¤å’Œå¯¹åº”çš„Intrinsicã€‚ï¼ˆæŒ‡ä»¤éƒ½æ˜¯AT&Tæ ¼å¼ï¼‰

+-------------------------+-------------------------+--------------------------------------+
| Intrinsic               | æŒ‡ä»¤                    | æè¿°                                 |
+=========================+=========================+======================================+
| _mm256_loadu_pd         | VMOVUPD m256, ymm       | å°†å†…å­˜ä¸­è¿ç»­çš„4ä¸ªdoubleè¯»å…¥ymm       |
+-------------------------+-------------------------+--------------------------------------+
| _mm256_storeu_pd        | VMOVUPD ymm, m256       | å°†ymmå¯„å­˜å™¨ä¸­çš„4ä¸ªdoubleå†™å…¥è¿ç»­å†…å­˜ |
+-------------------------+-------------------------+----------------------+
| _mm256_add_pd           | VADDPD ymm1, ymm2, ymm3 | ymm3 = ymm2 + ymm1      |
+-------------------------+-------------------------+----------------------+
| _mm256_sub_pd           | VSUBPD ymm1, ymm2, ymm3 | ymm3 = ymm2 - ymm1      |
+-------------------------+-------------------------+----------------------+
| _mm256_mul_pd           | VMULPD ymm1, ymm2, ymm3 | ymm3 = ymm2 * ymm1      |
+-------------------------+-------------------------+----------------------+
| _mm256_div_pd           | VDIVPD ymm1, ymm2, ymm3 | ymm3 = ymm2 / ymm1      |
+-------------------------+-------------------------+----------------------+
| _mm256_permute4x64_pd   | VPERMPD imm8, ymm1, ymm2| ymm1æŒ‰ç…§imm8æ‰€è¿°é‡æ’å…¥ymm2 |
+-------------------------+-------------------------+-------------------------+


è§£é‡Šä¸€ä¸‹é™¤æ³•å’Œå‡æ³•åè¿‡æ¥çš„é—®é¢˜ã€‚å‰é¢æåˆ°AT&Tæ±‡ç¼–å’ŒIntelæ±‡ç¼–æ˜¯åå‘çš„ã€‚åœ¨MOVä¹‹ç±»çš„æŒ‡ä»¤ä¸­ï¼ŒAT&Tæ ¼å¼çœ‹èµ·æ¥å’Œè°ä¸€ç‚¹ï¼Œç»“æœå°±æ˜¯åœ¨å‡æ³•å’Œé™¤æ³•çš„åœ°æ–¹åè¿‡æ¥äº†ã€‚

å…³äºpermuteï¼Œimm8æ˜¯ä¸€ä¸ªç«‹å³æ•°ï¼Œæ¯ä¸¤ä½ä¸ºä¸€ç»„ï¼Œè¡¨ç¤ºymmä¸­çš„ç¬¬æŸä¸ªæ•°ã€‚    

> ä¾‹ï¼š  
ymm1 = (a, b, c, d)    
VPEMPD $0xc5, ymm1, ymm2    
=> ymm2 = (b, b, a, d)

æ˜¯è¿™æ ·çš„ï¼Œ0xc5 = 11 00 01 01 (b). 00å¯¹åº”aï¼Œ01å¯¹åº”bï¼Œ10å¯¹åº”cï¼Œ11å¯¹åº”dã€‚
è€Œä»MSBåˆ°LSBçš„é¡ºåºæ˜¯(3,2,1,0)çš„é¡ºåºã€‚å› æ­¤ç›®æ ‡çš„ç¬¬0ä¸ªdoubleæ˜¯æ ¹æ®æœ€ä½ä¸¤ä½01å–æ•°æ®ï¼Œå–åˆ°bï¼› ç¬¬ä¸€ä¸ªåŒç†ï¼Œ01->bï¼›ç¬¬äºŒä¸ªæ˜¯00ï¼Œå–aï¼›ç¬¬ä¸‰ä¸ªæ˜¯11ï¼Œå–dã€‚å¦å¤–ï¼Œå¦‚æœå†…å­˜é‡Œè¿ç»­çš„doubleæ˜¯(a,b,c,d)çš„è¯ï¼ŒVMOVUPDå–è¿›ymmå¯„å­˜å™¨çš„å€¼å°±æ˜¯(a,b,c,d).å¦‚æœå‚è€ƒä¸€äº›æ±‡ç¼–æ‰‹å†Œï¼Œå¯èƒ½ä¼šå‘ç°æ‰‹å†Œé‡Œå†™çš„æ˜¯åè¿‡æ¥çš„(d,c,b,a).è¿™åªæ˜¯è¡¨ç¤ºæ–¹æ³•ä¸åŒã€‚åœ¨æ±‡ç¼–æ‰‹å†Œé‡Œä¹ æƒ¯æŒ‰ç…§ä½ä½åœ¨å³é«˜ä½åœ¨å·¦çš„é¡ºåºè¡¨ç¤ºã€‚


# cè¯­è¨€å¤šçº¿ç¨‹ç¼–ç¨‹ {#cmt}

è¿™éƒ¨åˆ†æˆ‘ä¹Ÿæ˜¯ç°å­¦ç°å–ã€‚C11æ ‡å‡†å¼•å…¥äº†çº¿ç¨‹æ”¯æŒï¼Œä½†æ˜¯ç›´åˆ°glibcçš„2.28ç‰ˆæœ¬æ‰å®ç°äº†C11æ ‡å‡†çš„çº¿ç¨‹ã€‚ä¸å¹¸æœåŠ¡å™¨ä¸Šçš„glibcç‰ˆæœ¬æ˜¯2.17ã€‚

å…¶å®åœ¨linuxä¸‹ï¼Œcè¯­è¨€æ—©å·²æœ‰çº¿ç¨‹åº“pthreadäº†ã€‚æ®è¯´glibcé‡Œçš„çº¿ç¨‹åº“å°±æ˜¯ç›´æ¥æŠŠpthreadå°è£…äº†ä¸€ä¸‹    
(ï½ï¿£â–½ï¿£)ï½

å…¶å®pthreadå’Œthreadæˆ‘éƒ½ä¸ä¼šç”¨ï¼Œä¸ºäº†æ‹¥æŠ±æ–°æ ‡å‡†ç®€å•å­¦ä¹ äº†ä¸€ä¸‹C11çš„threadï¼Œè¿™é‡Œå°±ç®€å•è®²ä¸€ä¸‹ã€‚

## è¿˜æ˜¯ä¹˜åŠ è¿ç®— {#cmt_muladd}

> _å¤§åˆ‡ãªäººã¨ã„ã¤ã‹ã¾ãŸå·¡ã‚Šä¼šãˆã¾ã™ã‚ˆã†ã«ã€‚â€”â€”ã€Plastic Memoriesã€_

è¿™é‡Œæ˜¯4ä¸ªçº¿ç¨‹è¿›è¡Œè¿ç®—çš„cä»£ç 

```{c muladd_mt.c, eval=F}
#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <threads.h>

struct Input{
    double* a;
    double* b;
    double* c;
    double* d;
    unsigned long long N;
    unsigned long long R;
};

__attribute__ ((noinline))
int muladd_th(void* input){
    struct Input* in;
    unsigned long long i, j;
    double* va;
    double* vb;
    double* vc;
    double* vd;
    in = (struct Input*)input;
    va = in->a;
    vb = in->b;
    vc = in->c;
    vd = in->d;
    for(i = 0; i < in->R; i++){
        for(j = 0; j < in->N; j++){
            vd[j] = va[j] * vb[j] + vc[j];
        }
    }
    return 0;
}

__attribute__ ((noinline))
void muladd(double* a, double* b, double* c,
            double* d, unsigned long long N,
            unsigned long long R){
    thrd_t threads[4];
    struct Input inputs[4];
    unsigned long long i;
    for(i = 0; i < 4; i++){
        inputs[i].a = a + N/4*i;
        inputs[i].b = b + N/4*i;
        inputs[i].c = c + N/4*i;
        inputs[i].d = d + N/4*i;
        inputs[i].N = N/4;
        inputs[i].R = R;
        if(i == 3){
            inputs[i].N = N-N/4*3;
        }
        thrd_create(&(threads[i]), muladd_th, &(inputs[i]));
    }
    for(i = 0; i < 4; i++){
        thrd_join((threads[i]), NULL);
    }
    
}

int main(){
    double* a = (double*)(malloc(8192*sizeof(double)));
    double* b = (double*)(malloc(8192*sizeof(double)));
    double* c = (double*)(malloc(8192*sizeof(double)));
    double* d = (double*)(malloc(8192*sizeof(double)));
    
    //Prepare data
    unsigned long long i;
    for(i = 0; i < 8192; i++){
        a[i] = (double)(rand()%2000) / 200.0;
        b[i] = (double)(rand()%2000) / 200.0;
        c[i] = ((double)i)/10000.0;
    }
    
    struct timespec start, stop;
    double elapsed;
    clock_gettime(CLOCK_MONOTONIC, &start);

    muladd(a, b, c, d, 8192, 1000000);
    clock_gettime(CLOCK_MONOTONIC, &stop);
    elapsed = (double)(stop.tv_sec-start.tv_sec);
    elapsed += (double)(stop.tv_nsec-start.tv_nsec)/ 1000000000.0;
    printf("Elapsed time = %8.6f s\n", elapsed);
    for(i = 0; i < 8192; i++){
        if(i % 1001 == 0){
            printf("%5llu: %16.8f * %16.8f + %16.8f = %16.8f (%d)\n",
                   i, a[i], b[i], c[i], d[i], d[i]==a[i]*b[i]+c[i]);
        }
    }

    free(a);
    free(b);
    free(c);
    free(d);
}


```

> ç®€å•è¯´ä¸€ä¸‹ã€‚éœ€è¦`#include <threads.h>`ã€‚è¿™é‡ŒæŠŠ4096ç»´æ•°ç»„æ‹†æˆ4ä»½ï¼Œåˆ†åˆ«ç”±å››ä¸ªçº¿ç¨‹å®Œæˆè®¡ç®—ã€‚1,000,000æ¬¡çš„å¾ªç¯ä¹Ÿæ”¾åˆ°çº¿ç¨‹é‡Œé¢åšã€‚æ­¤å¤–ï¼Œè¿™é‡Œè¿˜æ›´æ¢äº†è®¡æ—¶å‡½æ•°ã€‚ç”±äºä¹‹å‰ä½¿ç”¨çš„è®¡æ—¶å‡½æ•°åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ä¼šæŠŠæ¯ä¸ªçº¿ç¨‹çš„æ—¶é—´åŠ èµ·æ¥ï¼Œè®¡ç®—çš„æ—¶é—´å°±ä¸å¯¹äº†ã€‚å¦‚æœäº²è‡ªè¯•ä¸€è¯•çš„è¯ï¼Œä¼šå‘ç°æ„Ÿå—åˆ°çš„æ—¶é—´æ¯”è¾“å‡ºçš„æ—¶é—´è¦çŸ­ã€‚

> æ­¤å¤–ï¼Œä¸Šè¿°ç¨‹åºéœ€è¦glibc>=2.28. è¦å†x40ä¸Šè¿è¡Œçš„è¯å¯ä»¥è‡ªå·±ç¼–è¯‘ä¸€ä¸ªglibcã€‚æˆ‘å°è¯•äº†ç¼–è¯‘glibc 2.30ã€‚glibc 2.30éœ€è¦çš„gmakeç‰ˆæœ¬æ¯”x40å¸¦æœ‰çš„è¦é«˜ä¸€äº›ï¼Œæ‰€ä»¥åˆå¾—è‡ªå·±ç¼–è¯‘ä¸€ä¸ªgmakeã€‚ç®€å•è¯´ä¸€ä¸‹æµç¨‹ï¼š    
>    
>> ä¸‹è½½æœ€æ–°çš„gnu makeçš„æºä»£ç ï¼Œå†é‡Œé¢ç›´æ¥    
>>    
>> ```{bash, eval=F}
  $ ./configure
  $ make
```
>>    
>>å¾—åˆ°ä¸€ä¸ª`make`çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚    
å°†è¿™ä¸ª`make`é‡å‘½åä¸º`gmake`å¹¶æ‹·è´åˆ°ä¸€ä¸ªåœ°æ–¹ï¼Œæ¯”å¦‚`~/bin/`    
å†æŠŠè¿™ä¸ªåœ°æ–¹åŠ å…¥åˆ°\$PATHç¯å¢ƒå˜é‡é‡Œ`export PATH=~/bin/:$PATH`.    
ç„¶åä¸‹è½½glibc 2.30çš„æºä»£ç ï¼Œè§£å‹ã€‚åœ¨å…¶ç›®å½•é‡Œé¢åˆ›å»ºä¸€ä¸ª`build`æ–‡ä»¶å¤¹å¹¶è¿›å…¥ã€‚    
>>    
>> ```{bash, eval=F}
  $ ../configure --prefix=~/glibc230/
  $ gmake -j10 all
  $ gmake install
```
>>    
>> æ³¨æ„ä¸€å®šè¦æŒ‡å®š`--prefix`,å¦åˆ™`make install`ä¼šå°è¯•å°†glibcå®‰è£…åˆ°ç³»ç»Ÿç›®å½•ã€‚    
è¿™é‡Œå‡è®¾ä½ å°†glibcå®‰è£…åˆ°`~/glibc230`.   
å®‰è£…å¥½ä»¥åå°±å¯ä»¥ç¼–è¯‘muladd_mt.cäº†    
>>    
>> ```{bash, eval=F}
gcc -L~/glibc230/lib -I~/glibc230/include \
-Wl,--rpath=~/glibc230/lib \
-Wl,--dynamic-linker=~/glibc230/lib/ld-linux-x86-64.so.2 \
-std=c11 \
-o muladd_mt muladd_mt.c -pthread
```

ç»“æœï¼Œç”¨æ—¶6ç§’å·¦å³ã€‚

**æ³¨æ„ï¼åé¢çš„`thrd_join((threads[i]), NULL);`éå¸¸é‡è¦ï¼Œä¸€å®šä¸å¯çœç•¥ã€‚**è¿™å¥è¯ä¿è¯äº†è°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹åœ¨è¿™é‡Œç­‰ï¼Œç›´åˆ°threads[i]çš„çº¿ç¨‹ç»“æŸã€‚ç¬¬äºŒä¸ªå‚æ•°å¦‚æœä¸æ˜¯NULLçš„è¯ï¼Œthreads[i]çº¿ç¨‹ä¼šæŠŠè¿”å›å€¼å†™åˆ°ç¬¬äºŒå‚æ•°æŒ‡ç¤ºçš„åœ°å€ã€‚å¦‚æœä¸å†™`thrd_join`ä¼šå¯¼è‡´ä¸»çº¿ç¨‹æå‰é€€å‡ºï¼Œäºæ˜¯threads[i]çº¿ç¨‹çš„è¿è¡Œç»“æœå°±æ‹¿ä¸åˆ°äº†ã€‚è¿™æ˜¯ä¸å¥½çš„ã€‚

`thrd_create`å‡½æ•°çš„ä¸‰ä¸ªå‚æ•°ï¼š    
ç¬¬ä¸€ä¸ªæ˜¯ä¸€ä¸ªæŒ‡å‘`thrd_t`ç»“æ„çš„æŒ‡é’ˆï¼Œåé¢`thrd_join`ç­‰æ“ä½œéƒ½éœ€è¦è¿™ä¸ª`thrd_t`ç»“æ„ï¼Œç›¸å½“äºçº¿ç¨‹çš„ç¼–å·ã€‚    
ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ(ç›´æ¥ç”¨å‡½æ•°åå³å¯)ã€‚è¿™ä¸ªå‡½æ•°å¿…é¡»æ˜¯æ¥å—ä¸€ä¸ª`void*`å‚æ•°å¹¶è¿”å›ä¸€ä¸ª`int`çš„å‡½æ•°ã€‚`void*`å‚æ•°ç”¨æ¥å‘çº¿ç¨‹ä¼ é€’æ•°æ®ã€‚    
ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯è¦å‘ä¸Šè¿°å‡½æ•°ä¼ å…¥çš„å‚æ•°ã€‚ç”±äºå‚æ•°éœ€è¦æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå› æ­¤åœ¨ä¸Šé¢çš„ç¨‹åºé‡Œé¢è®¾è®¡äº†ä¸€ä¸ªç»“æ„`Input`ï¼Œé‡Œé¢åŒ…å«äº†è®¡ç®—æ‰€éœ€çš„ä¿¡æ¯ã€‚    
åˆ›å»ºå®Œåçº¿ç¨‹å°±è¿è¡Œèµ·æ¥äº†ã€‚è¿™æ—¶è¯¥å¹²å•¥å¹²å•¥ï¼Œç„¶åç”¨`thrd_join`ç­‰ç»“æœå°±è¡Œäº†ã€‚

## æœ¬ç« å°ç»“ {#cmt_sum}

åˆæ˜¯è¿™ä¸ªç¯èŠ‚ï¼çº¿ç¨‹æ¯”SIMDçµæ´»å¤šäº†ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥åšä¸åŒçš„äº‹æƒ…ï¼ˆå¯ä»¥æ ¹æ®ä¼ å…¥çš„å‚æ•°åˆ¤æ–­ä¸€ä¸‹ï¼‰ã€‚çº¿ç¨‹ä»¬åœ¨å¤šæ ¸å¿ƒCPUä¸Šå¯ä»¥åŒæ—¶æ‰§è¡Œï¼Œå¯ä»¥çœ‹åˆ°åŒæ ·çš„å†…å­˜ç©ºé—´ã€‚ç”¨ä¸ªå¾ªç¯æŠŠå®ƒä»¬å®‰æ’æ˜ç™½å°±å¯ä»¥å¼€å§‹ç­‰äº†ğŸ˜ƒ

ç›¸ä¿¡ä½ çš„è„‘ä¸­åˆä¸€æ¬¡å……æ»¡äº†é—®å·ï¼Œæˆ‘å†å°è¯•è‡ªé—®è‡ªç­”ä¸€ä¸‹ã€‚

--------

**é—®ï¼šè¿™é‡Œä¹Ÿæ˜¯muladdå‡½æ•°ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥æŠŠå®ƒæ‰§è¡Œ1,000,000éï¼Ÿ**    
ç­”ï¼šè¿™æ˜¯å› ä¸ºçº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯æ˜¯æœ‰ä»£ä»·çš„ã€‚é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¼šå ç”¨è¿‡å¤šçš„èµ„æºã€‚æœ€å¥½æ˜¯åˆ›å»ºå¥½çº¿ç¨‹åè®©å®ƒæ‰§è¡Œä¸€æ•´å¥—ä»»åŠ¡ã€‚æ­¤å¤–ï¼Œæœ‰ä¸€ç§â€œçº¿ç¨‹æ± â€çš„æŠ€æœ¯ï¼Œå¯ä»¥å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«ä¸€äº›çº¿ç¨‹çš„æ± ï¼Œç„¶åå‘çº¿ç¨‹æ± å‘é€ä»»åŠ¡ã€‚æ¥åˆ°ä»»åŠ¡åçº¿ç¨‹æ± ä¼šè‡ªåŠ¨å”¤é†’ä¸€ä¸ªçº¿ç¨‹å–æ‰§è¡Œä»»åŠ¡ï¼Œè¿™æ ·å°±é¿å…äº†é¢‘ç¹åˆ›å»º/é”€æ¯çº¿ç¨‹æ‰€éœ€çš„å¼€é”€ã€‚ç„¶è€Œç”±äºæˆ‘å­¦è‰ºä¸ç²¾ï¼Œå¹¶ä¸çŸ¥é“å…·ä½“å¦‚ä½•å®ç°ä¸€ä¸ªçº¿ç¨‹æ± ï¼ˆä½†æ˜¯æƒ³å¿…å­˜åœ¨å¼€æºçš„å·²ç»å†™å¥½çš„çº¿ç¨‹æ± åº“ï¼‰ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­å‡†å¤‡æ•°æ®ï¼Œæ¯å‡†å¤‡å¥½ä¸€éƒ¨åˆ†å°±å¼€å¯ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œæœ€åå†ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸåæ”¶é›†å¥½è®¡ç®—ç»“æœã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œæœ€å¤§çº¿ç¨‹æ•°é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œè¯·åˆç†åˆ’åˆ†æ•°æ®ã€‚

--------

**é—®ï¼šä½ è¿™å¤šçº¿ç¨‹ç¼–ç¨‹è‡ªå·±éƒ½ä¸ä¼šï¼Œè¿˜å‡ºæ¥å†™æŒ‡å—ï¼Ÿ**    
ç­”ï¼šæ­£å¸¸å°æœ‹å‹ä¸€èˆ¬é—®ä¸å‡ºæ¥è¿™ç§é—®é¢˜ã€‚

# ç¬¬ä¸€éƒ¨åˆ†ç»“æŸè¯­ {#fma}

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å€ŸåŠ©cè¯­è¨€äº†è§£äº†SIMDå’Œå¤šçº¿ç¨‹ç¼–ç¨‹çš„åŸºæœ¬çŸ¥è¯†ï¼Œå¹¶é€šè¿‡ç¤ºä¾‹ç¨‹åºå±•ç¤ºäº†å¹¶è¡Œè®¡ç®—å¸¦æ¥çš„æ€§èƒ½æå‡ã€‚    
å¸Œæœ›è¿™ä¸€éƒ¨åˆ†èƒ½å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ã€‚

æœ€åçš„æœ€åï¼Œæˆ‘ä»¬æ¥è§£ç­”è¿™ä¸€éƒ¨åˆ†ä¸­æœ€ç¥ç§˜çš„é—®é¢˜ï¼š**ä¸ºä»€ä¹ˆè¦è®¡ç®—aÃ—b+cã€‚**å…¶å®ï¼Œæ˜¯ä¸ºäº†ä»‹ç»ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æŒ‡ä»¤â€”â€”FMAã€‚ç”±äºè¿™ä»½æŒ‡å—æ˜¯å…³äºå¹¶è¡Œè®¡ç®—çš„ï¼Œæ‰€ä»¥å…³äºFMAçš„äº‹æƒ…å°±æ”¾åœ¨è§’è½é‡Œäº†ã€‚    
FMA â€”â€” Fused Multiply-Addï¼Œç§°ä½œâ€œç§¯å’Œç†”åŠ â€è¿ç®—ã€‚è¯¥è¿ç®—ç›´æ¥è®¡ç®—a\*b+cçš„å€¼ã€‚å…¶å®è¿™æ¡æŒ‡ä»¤çš„ç›®çš„å¹¶ä¸æ˜¯åŠ é€Ÿè®¡ç®—ï¼ˆè™½ç„¶å¥½åƒçš„ç¡®æ¯”å…ˆä¹˜ååŠ å¿«ï¼‰ï¼Œå…¶ç›®çš„åœ¨äºæé«˜ç²¾åº¦ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œæµ®ç‚¹æ•°å¹¶ä¸æ˜¯æ— é™ç²¾åº¦çš„ï¼ˆå¯ä»¥å‚è€ƒé™„å½•ä¸­çš„æµ®ç‚¹æ•°çš„æœºå™¨è¡¨ç¤ºæ–¹æ³•ï¼‰ã€‚å…ˆä¹˜ååŠ åŒ…å«äº†ä¸¤æ¬¡è¿‘ä¼¼ï¼Œè€Œâ€œç§¯å’Œç†”åŠ â€åªè¿›è¡Œä¸€æ¬¡è¿‘ä¼¼ã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œè¿™æ¡æŒ‡ä»¤ä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ã€‚ç»´åŸºç™¾ç§‘ä¸Šæœ‰ä¸¾ä¾‹ï¼šè®¡ç®—$x^2-y^2$ï¼Œå¦‚æœ$x=y$ï¼Œè€Œç¨‹åºå†™æˆ`FMA(x,x,-y*y)`,é‚£ä¹ˆ`y*y`ä¼šå…ˆè¿›æ€§è¿‘ä¼¼ï¼Œä¹‹åå¯èƒ½ä¼šä¸`x*x`çš„ç²¾ç¡®å€¼ä¸ç›¸ç­‰ï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ªé0çš„ç»“æœã€‚å¦‚æœè¿›è¡Œå¤šæ­¥è¿ç®—ï¼Œè¯¯å·®ä¹Ÿè®¸ä¼šç´¯ç§¯åˆ°åé¢ï¼Œç”šè‡³é€æ¸æ”¾å¤§ã€‚ä¸è¿‡ä¸€èˆ¬æ¥è¯´ï¼ŒFMAè¿˜æ˜¯ä¸€ä¸ªå¥½æŒ‡ä»¤ã€‚åœ¨cè¯­è¨€ä¸­ï¼Œmath.hå®šä¹‰äº†fmaå‡½æ•°ç”¨äºåšâ€œç§¯å’Œç†”åŠ â€è¿ç®—ã€‚å…·ä½“çš„æ±‡ç¼–è¯­è¨€æ€ä¹ˆå†™å°±ä¸åœ¨è¿™é‡Œè¯¦è¿°äº†ã€‚












